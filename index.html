<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Top Sinais - Aviator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úàÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
      
      * {
        font-family: 'Inter', sans-serif;
      }
      
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
      }
      
      .glass-effect {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .vela-card {
        position: relative;
        overflow: visible;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      
      .vela-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      }
      
      .vela-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }
      
      .vela-card:hover::before {
        transform: translateX(100%);
      }
      
      .highlight {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
        color: #000 !important;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5) !important;
      }
      
      .dimmed {
        opacity: 0.6;
        filter: brightness(0.8);
      }
      
      .next-rosa {
        opacity: 1 !important;
        filter: brightness(1) !important;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
        border: 2px solid #ec4899;
      }
      
      .vela-rosa {
        background: linear-gradient(135deg, #ec4899 0%, #d00f70 100%);
        color: white;
      }
      
      .vela-roxa {
        background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        color: white;
      }
      
      .vela-azul {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
      }
      
      .vela-cinza {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
      }
      
      .numero-vela {
        font-size: 1rem;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      
      .horario-vela {
        font-size: 9px;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 0.15rem;
      }
      
      .header-gradient {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: .7;
        }
      }
      
      .custom-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a5b4fc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
      
      .interval-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        z-index: 20;
      }
      
      .interval-badge.before-rosa {
        border: 2px solid #ec4899;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.8);
      }
      
      @media (max-width: 640px) {
        .numero-vela {
          font-size: 0.85rem;
        }
        .horario-vela {
          font-size: 7.7px;
        }
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 2px solid rgba(239, 68, 68, 0.5);
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        transform: scale(0.9);
        transition: transform 0.3s ease;
      }

      .modal-overlay.active .modal-content {
        transform: scale(1);
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">
      <!-- Header -->
      <div class="glass-effect rounded-2xl p-6 sm:p-8 mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-center mb-2 header-gradient">
          üöÄ Top Sinais - Aviator
        </h1>
        <p class="text-center text-gray-400 text-sm sm:text-base">
          Hist√≥rico de velas em tempo real
        </p>
      </div>

      <!-- Selectors -->
      <div class="glass-effect rounded-2xl p-4 sm:p-6 mb-6 space-y-4">
        <div>
          <label for="casa-selector" class="block mb-3 text-sm sm:text-base font-semibold text-gray-300">
            üè† Selecione a Casa
          </label>
          <select
            id="casa-selector"
            class="custom-select glass-effect border border-indigo-500/30 text-white text-sm sm:text-base rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block w-full p-3 sm:p-4 transition-all cursor-pointer"
          >
            <option value="br4betcom">BR4BET</option>
            <option value="openbox">OpenBox</option>
            <option value="Jetx-ApostaTudo">Jetx - Aposta tudo</option>
             <option value="Jetx-Realsbet">Jetx - Realsbet</option>
          </select>
        </div>
        
        <div>
          <label for="color-filter" class="block mb-3 text-sm sm:text-base font-semibold text-gray-300">
            üé® Filtrar por Cor
          </label>
          <select
            id="color-filter"
            class="custom-select glass-effect border border-indigo-500/30 text-white text-sm sm:text-base rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block w-full p-3 sm:p-4 transition-all cursor-pointer"
          >
            <option value="all">Todas as Cores</option>
            <option value="rosa">üå∏ Rosas (‚â•10x)</option>
            <option value="roxa">üíú Roxas</option>
            <option value="azul">üíô Azuis</option>
          </select>
        </div>

        <div class="flex items-center justify-between p-4 glass-effect border border-indigo-500/30 rounded-xl">
          <div>
            <label for="interval-toggle" class="text-sm sm:text-base font-semibold text-gray-300 cursor-pointer">
              üìä Marcar Intervalos Rosa
            </label>
            <p class="text-xs text-gray-500 mt-1">Numera velas ap√≥s cada rosa</p>
          </div>
          <button
            id="interval-toggle"
            role="switch"
            aria-checked="false"
            class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600"
          >
            <span class="translate-x-1 inline-block h-5 w-5 transform rounded-full bg-white transition-transform"></span>
          </button>
        </div>

        <div class="mt-4">
          <button
            id="clear-history-btn"
            class="w-full px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
          >
            <span>üóëÔ∏è</span>
            <span>Limpar Todo Hist√≥rico</span>
          </button>
        </div>
      </div>

      <!-- Status Badge -->
      <div class="flex justify-center mb-6">
        <div class="glass-effect rounded-full px-4 sm:px-6 py-2 flex items-center gap-2">
          <div class="w-2 h-2 bg-green-500 rounded-full pulse-animation"></div>
          <span class="text-xs sm:text-sm font-medium text-gray-300">Conectado</span>
        </div>
      </div>

      <!-- An√°lise de Antecessores -->
      <div id="analise-antecessores" class="glass-effect rounded-xl p-3 mb-6 max-h-[200px] overflow-y-auto">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üìä Antecessores de Rosa:</span>
          <div id="antecessores-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando an√°lise...</span>
          </div>
        </div>
      </div>

      <!-- Antecessores Recentes -->
      <div id="antecessores-recentes" class="glass-effect rounded-xl p-3 mb-6">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üî• √öltimos 10 Antecessores:</span>
          <div id="antecessores-recentes-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando...</span>
          </div>
        </div>
      </div>

      <!-- Grid de Velas -->
      <div id="historico-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-2 sm:gap-2.5">
        <!-- As velas ser√£o inseridas aqui -->
      </div>

      <!-- Loading State -->
      <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-400">Carregando velas...</p>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="text-2xl font-bold text-white mb-2">Confirmar Exclus√£o</h2>
          <p class="text-gray-400 text-sm">Esta a√ß√£o n√£o pode ser desfeita!</p>
        </div>
        
        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
          <p class="text-white font-semibold mb-2">Voc√™ est√° prestes a excluir:</p>
          <p class="text-red-400 text-sm">
            ‚úó Todo o hist√≥rico de velas da casa: <span id="modal-casa-name" class="font-bold"></span>
          </p>
        </div>

        <div class="flex gap-3">
          <button
            id="modal-cancel-btn"
            class="flex-1 px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-xl transition-all duration-200"
          >
            Cancelar
          </button>
          <button
            id="modal-confirm-btn"
            class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2"
          >
            <span>üóëÔ∏è</span>
            <span>Confirmar Exclus√£o</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const SUPABASE_URL = "https://zdkqorcrppituzmgeuon.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpka3FvcmNycHBpdHV6bWdldW9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwODkwNTcsImV4cCI6MjA2MzY2NTA1N30.ULLInPNIQCwYzCqkt_v-w7kZH31ACTz_03DNLG4ZA8E";

        let supabaseClient;
        try {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log("‚úÖ Supabase client initialized successfully");
        } catch (e) {
          console.error("‚ùå Error initializing Supabase client:", e);
          return;
        }

        const casaSelector = document.getElementById("casa-selector");
        const colorFilter = document.getElementById("color-filter");
        const intervalToggle = document.getElementById("interval-toggle");
        const historicoContainer = document.getElementById("historico-container");
        const loadingElement = document.getElementById("loading");
        let selectedNumber = null;
        let selectedColorFilter = "all";
        let showIntervals = false;

        function formatDate(timestamp) {
          const date = new Date(timestamp);
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          const seconds = String(date.getSeconds()).padStart(2, '0');
          return `${day}/${month}/${year} - ${hours}:${minutes}:${seconds}`;
        }

        async function fetchVelas() {
          const casa = casaSelector.value;
          if (!casa) return;

          const { data, error } = await supabaseClient
            .from("velas")
            .select("*")
            .eq("casa", casa)
            .order("horario", { ascending: false })
            .limit(5000);

          if (error) {
            console.error("‚ùå Error fetching velas:", error);
            return;
          }

          renderVelas(data);
        }

        function getVelaClass(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "vela-rosa";
          }
          if (vela.cor === "roxa") {
            return "vela-roxa";
          }
          if (vela.cor === "azul") {
            return "vela-azul";
          }
          return "vela-cinza";
        }

        function getVelaType(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "rosa";
          }
          return vela.cor;
        }

        function shouldShowVela(velaType) {
          if (selectedColorFilter === "all") return true;
          return velaType === selectedColorFilter;
        }

        function analisarAntecessores(velas) {
          const antecessoresMap = new Map();
          const totalAparicoesMap = new Map();
          
          // Verifica se as primeiras 50 velas (mais recentes) n√£o t√™m nenhuma rosa
          let temRosaNas20Primeiras = false;
          for (let i = 0; i < Math.min(50, velas.length); i++) {
            const isRosa = parseFloat(velas[i].numero) >= 10;
            if (isRosa) {
              temRosaNas20Primeiras = true;
              break;
            }
          }
          
          // Se n√£o h√° rosa nas √∫ltimas 50 velas E temos pelo menos 50 velas, ignora os padr√µes anteriores
          if (!temRosaNas20Primeiras && velas.length >= 50) {
            return [];
          }
          
          // Conta todas as apari√ß√µes de cada n√∫mero
          velas.forEach(vela => {
            const numero = parseFloat(vela.numero).toFixed(2);
            totalAparicoesMap.set(numero, (totalAparicoesMap.get(numero) || 0) + 1);
          });
          
          // Percorre todas as velas para encontrar rosas e seus antecessores
          for (let i = 0; i < velas.length; i++) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              // Verifica at√© 2 casas antes
              for (let j = 1; j <= 2; j++) {
                if (i + j < velas.length) {
                  const antecessor = velas[i + j];
                  const antecessorNumero = parseFloat(antecessor.numero).toFixed(2);
                  
                  if (!antecessoresMap.has(antecessorNumero)) {
                    antecessoresMap.set(antecessorNumero, { 
                      acertos: 0, 
                      positions: [],
                      totalAparicoes: totalAparicoesMap.get(antecessorNumero) || 0
                    });
                  }
                  
                  const data = antecessoresMap.get(antecessorNumero);
                  data.acertos++;
                  data.positions.push(j);
                }
              }
            }
          }
          
          // Pega as duas velas mais recentes (posi√ß√µes 1 e 2)
          const velasAtuais = new Set();
          if (velas.length >= 1) velasAtuais.add(parseFloat(velas[0].numero).toFixed(2));
          if (velas.length >= 2) velasAtuais.add(parseFloat(velas[1].numero).toFixed(2));
          
          // Filtra apenas antecessores com pelo menos 3 apari√ß√µes totais
          // E probabilidade m√≠nima de 20% para garantir lucro saindo em 5x
          const antecessoresRelevantes = Array.from(antecessoresMap.entries())
            .filter(([numero, data]) => data.totalAparicoes >= 3)
            .map(([numero, data]) => {
              const erros = data.totalAparicoes - data.acertos;
              const probabilidade = ((data.acertos / data.totalAparicoes) * 100).toFixed(1);
              const isAtual = velasAtuais.has(numero);
              
              return {
                numero,
                acertos: data.acertos,
                erros,
                totalAparicoes: data.totalAparicoes,
                probabilidade,
                positions: data.positions,
                isAtual
              };
            })
            .filter(data => parseFloat(data.probabilidade) >= 20) // M√≠nimo 20% para lucro
            .sort((a, b) => parseFloat(b.probabilidade) - parseFloat(a.probabilidade))
            .slice(0, 10); // Limita aos top 10
          
          return antecessoresRelevantes;
        }
        
        function renderAnalisesAntecessores(antecessores) {
          const antecessoresList = document.getElementById('antecessores-list');
          
          if (antecessores.length === 0) {
            antecessoresList.innerHTML = '<span class="text-gray-500">Nenhum padr√£o lucrativo encontrado (m√≠n. 3 apari√ß√µes e 20% de acerto para lucro saindo em 5x)</span>';
            return;
          }
          
          antecessoresList.innerHTML = antecessores.map(data => {
            const posicoes = {};
            data.positions.forEach(pos => {
              posicoes[pos] = (posicoes[pos] || 0) + 1;
            });
            
            const detalhes = Object.entries(posicoes)
              .map(([pos, count]) => `${count}x na ${pos}¬™ casa`)
              .join(', ');
            
            // Define cor da probabilidade
            let probColor = 'text-gray-400';
            const prob = parseFloat(data.probabilidade);
            if (prob >= 70) probColor = 'text-green-400';
            else if (prob >= 50) probColor = 'text-yellow-400';
            else if (prob >= 30) probColor = 'text-orange-400';
            else probColor = 'text-red-400';
            
            // Badge de vela atual
            const atualBadge = data.isAtual 
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded">ATUAL</span>' 
              : '';
            
            return `
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-pink-500/20 to-purple-500/20 border border-pink-500/30">
                ${atualBadge}
                <span class="font-bold text-pink-400">${data.numero}x</span>
                <span class="text-gray-400">‚Üí</span>
                <span class="${probColor} font-bold text-sm">${data.probabilidade}%</span>
                <span class="text-gray-500 text-xs">|</span>
                <span class="text-green-400 font-semibold text-xs">${data.acertos}‚úì</span>
                <span class="text-red-400 font-semibold text-xs">${data.erros}‚úó</span>
                <span class="text-gray-500 text-xs">(${detalhes})</span>
              </span>
            `;
          }).join('');
        }

        function extrairAntecessoresRecentes(velas) {
          const antecessoresRecentes = [];
          
          // Percorre as velas mais recentes para encontrar as √∫ltimas 5 rosas
          for (let i = 0; i < velas.length && antecessoresRecentes.length < 5; i++) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              // Pega os antecessores (1¬™ e 2¬™ casa antes da rosa)
              const antecessoresDaRosa = [];
              
              if (i + 1 < velas.length) {
                antecessoresDaRosa.push({
                  numero: parseFloat(velas[i + 1].numero).toFixed(2),
                  posicao: 1,
                  horario: velas[i + 1].horario
                });
              }
              
              if (i + 2 < velas.length) {
                antecessoresDaRosa.push({
                  numero: parseFloat(velas[i + 2].numero).toFixed(2),
                  posicao: 2,
                  horario: velas[i + 2].horario
                });
              }
              
              antecessoresRecentes.push({
                rosa: parseFloat(vela.numero).toFixed(2),
                horarioRosa: vela.horario,
                antecessores: antecessoresDaRosa
              });
            }
          }
          
          return antecessoresRecentes;
        }

        function renderAntecessoresRecentes(antecessoresRecentes) {
          const antecessoresRecentesList = document.getElementById('antecessores-recentes-list');
          
          if (antecessoresRecentes.length === 0) {
            antecessoresRecentesList.innerHTML = '<span class="text-gray-500">Nenhuma rosa encontrada recentemente</span>';
            return;
          }
          
          // Pega as duas velas mais recentes para verificar se s√£o atuais
          const velasAtuais = new Set();
          if (window.velasGlobais && window.velasGlobais.length >= 1) {
            velasAtuais.add(parseFloat(window.velasGlobais[0].numero).toFixed(2));
          }
          if (window.velasGlobais && window.velasGlobais.length >= 2) {
            velasAtuais.add(parseFloat(window.velasGlobais[1].numero).toFixed(2));
          }
          
          // Filtra apenas antecessores azuis
          const antecessoresAzuis = [];
          
          for (const item of antecessoresRecentes) {
            if (item.antecessores.length > 0) {
              const primeiroAntecessor = item.antecessores[0];
              
              // Busca a vela original para verificar a cor
              const velaOriginal = window.velasGlobais.find(v => 
                parseFloat(v.numero).toFixed(2) === primeiroAntecessor.numero &&
                v.horario === primeiroAntecessor.horario
              );
              
              // Verifica se √© azul
              if (velaOriginal && velaOriginal.cor === 'azul') {
                antecessoresAzuis.push({
                  numero: primeiroAntecessor.numero,
                  isAtual: velasAtuais.has(primeiroAntecessor.numero)
                });
              }
            }
            
            // Para quando tiver 10 antecessores azuis
            if (antecessoresAzuis.length >= 10) break;
          }
          
          if (antecessoresAzuis.length === 0) {
            antecessoresRecentesList.innerHTML = '<span class="text-gray-500">Nenhum antecessor azul encontrado</span>';
            return;
          }
          
          antecessoresRecentesList.innerHTML = antecessoresAzuis.map(item => {
            // Define estilo baseado se √© atual ou n√£o
            const bgClass = item.isAtual 
              ? 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30' 
              : 'bg-gradient-to-r from-blue-500/20 to-blue-600/20 border-blue-500/30';
            
            const textClass = item.isAtual ? 'text-pink-400' : 'text-blue-400';
            
            const atualBadge = item.isAtual 
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded">ATUAL</span>' 
              : '';
            
            return `
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg ${bgClass} border">
                ${atualBadge}
                <span class="font-bold ${textClass}">üíô ${item.numero}x</span>
              </span>
            `;
          }).join('');
        }

        function renderVelas(velas) {
          loadingElement.classList.add('hidden');
          historicoContainer.innerHTML = "";
          
          // Armazena velas globalmente para uso em outras fun√ß√µes
          window.velasGlobais = velas;
          
          // Analisa antecessores
          const antecessores = analisarAntecessores(velas);
          renderAnalisesAntecessores(antecessores);
          
          // Extrai e renderiza antecessores recentes
          const antecessoresRecentes = extrairAntecessoresRecentes(velas);
          renderAntecessoresRecentes(antecessoresRecentes);
          
          // Primeiro, calcular os intervalos percorrendo do mais antigo para o mais recente
          const velasComIntervalo = [];
          let intervalCount = 0;
          let countingInterval = false;
          
          // Percorre do final para o in√≠cio (mais antigo para mais recente)
          for (let i = velas.length - 1; i >= 0; i--) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              countingInterval = true;
              intervalCount = 0;
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            } else if (countingInterval) {
              intervalCount++;
              velasComIntervalo.unshift({ vela, intervalo: intervalCount });
            } else {
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            }
          }
          
          // Agora renderiza as velas com os intervalos corretos
          velasComIntervalo.forEach(({ vela, intervalo }, index) => {
            const velaElement = document.createElement("div");
            const numero = parseFloat(vela.numero).toFixed(2);
            const horario = formatDate(vela.horario);
            const velaType = getVelaType(vela);
            const isRosa = parseFloat(vela.numero) >= 10;
            
            // Verifica se a pr√≥xima vela √© rosa (√∫ltima antes da rosa)
            const isBeforeRosa = index > 0 && parseFloat(velasComIntervalo[index - 1].vela.numero) >= 10;
            const badgeClass = isBeforeRosa ? 'interval-badge before-rosa' : 'interval-badge';
            
            const intervalBadge = showIntervals && !isRosa && intervalo > 0
              ? `<div class="${badgeClass}">${intervalo}</div>`
              : '';
            
            velaElement.innerHTML = `
              ${intervalBadge}
              <div class="numero-vela">${numero}x</div>
              <div class="horario-vela">${horario}</div>
            `;
            
            velaElement.dataset.numero = numero;
            velaElement.dataset.type = velaType;
            velaElement.className = `vela-card p-2 sm:p-2.5 rounded-xl text-center cursor-pointer ${getVelaClass(vela)}`;

            // Aplica filtro de cor
            if (!shouldShowVela(velaType)) {
              velaElement.classList.add("dimmed");
            }

            if (selectedNumber && velaElement.dataset.numero === selectedNumber) {
              velaElement.classList.add("highlight");
            } else if (selectedNumber) {
              velaElement.classList.add("dimmed");
            }

            historicoContainer.appendChild(velaElement);
          });
          
          // Aplica o destaque nas velas rosas ap√≥s selecionadas
          if (selectedNumber) {
            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              if (velaDiv.dataset.numero === selectedNumber && index > 0) {
                const nextVela = allVelas[index - 1];
                const nextNumero = parseFloat(nextVela.dataset.numero);
                if (nextNumero >= 10) {
                  nextVela.classList.remove("dimmed");
                  nextVela.classList.add("next-rosa");
                }
              }
            });
          }
        }

        function handleVelaClick(event) {
          const target = event.target.closest('.vela-card');
          if (target && target.dataset.numero) {
            const clickedNumber = target.dataset.numero;

            if (selectedNumber === clickedNumber) {
              selectedNumber = null;
            } else {
              selectedNumber = clickedNumber;
            }

            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              velaDiv.classList.remove("highlight", "dimmed", "next-rosa");
              
              if (selectedNumber) {
                // Se o n√∫mero atual √© o selecionado, destaca
                if (velaDiv.dataset.numero === selectedNumber) {
                  velaDiv.classList.add("highlight");
                  
                  // Verifica se a pr√≥xima vela √© rosa (>= 10)
                  if (index > 0) {
                    const nextVela = allVelas[index - 1];
                    const nextNumero = parseFloat(nextVela.dataset.numero);
                    if (nextNumero >= 10) {
                      nextVela.classList.remove("dimmed");
                      nextVela.classList.add("next-rosa");
                    }
                  }
                } else {
                  // Escurece as outras velas
                  velaDiv.classList.add("dimmed");
                }
              }
            });
          }
        }

        casaSelector.addEventListener("change", () => {
          selectedNumber = null;
          loadingElement.classList.remove('hidden');
          fetchVelas();
        });

        colorFilter.addEventListener("change", () => {
          selectedColorFilter = colorFilter.value;
          selectedNumber = null;
          fetchVelas();
        });

        intervalToggle.addEventListener("click", () => {
          showIntervals = !showIntervals;
          intervalToggle.setAttribute("aria-checked", showIntervals);
          
          if (showIntervals) {
            intervalToggle.classList.remove("bg-gray-600");
            intervalToggle.classList.add("bg-indigo-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-1");
            intervalToggle.querySelector("span").classList.add("translate-x-6");
          } else {
            intervalToggle.classList.remove("bg-indigo-600");
            intervalToggle.classList.add("bg-gray-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-6");
            intervalToggle.querySelector("span").classList.add("translate-x-1");
          }
          
          fetchVelas();
        });

        historicoContainer.addEventListener("click", handleVelaClick);

        // Modal functionality
        const confirmModal = document.getElementById("confirm-modal");
        const clearHistoryBtn = document.getElementById("clear-history-btn");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");
        const modalConfirmBtn = document.getElementById("modal-confirm-btn");
        const modalCasaName = document.getElementById("modal-casa-name");

        // Get casa display name
        function getCasaDisplayName(casaValue) {
          const option = casaSelector.querySelector(`option[value="${casaValue}"]`);
          return option ? option.textContent : casaValue;
        }

        // Open modal
        clearHistoryBtn.addEventListener("click", () => {
          const casaName = getCasaDisplayName(casaSelector.value);
          modalCasaName.textContent = casaName;
          confirmModal.classList.add("active");
        });

        // Close modal on cancel
        modalCancelBtn.addEventListener("click", () => {
          confirmModal.classList.remove("active");
        });

        // Close modal on overlay click
        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) {
            confirmModal.classList.remove("active");
          }
        });

        // Delete history on confirm
        modalConfirmBtn.addEventListener("click", async () => {
          const casa = casaSelector.value;
          
          // Disable button and show loading state
          modalConfirmBtn.disabled = true;
          modalConfirmBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></span><span>Excluindo...</span>';
          
          try {
            const { error } = await supabaseClient
              .from("velas")
              .delete()
              .eq("casa", casa);

            if (error) {
              console.error("‚ùå Error deleting history:", error);
              alert("Erro ao excluir hist√≥rico: " + error.message);
            } else {
              console.log("‚úÖ History deleted successfully for casa:", casa);
              
              // Close modal
              confirmModal.classList.remove("active");
              
              // Clear the display
              historicoContainer.innerHTML = "";
              
              // Show success message
              const successMsg = document.createElement("div");
              successMsg.className = "glass-effect rounded-xl p-6 text-center";
              successMsg.innerHTML = `
                <div class="text-5xl mb-4">‚úÖ</div>
                <p class="text-white font-semibold text-lg mb-2">Hist√≥rico exclu√≠do com sucesso!</p>
                <p class="text-gray-400 text-sm">Casa: ${getCasaDisplayName(casa)}</p>
              `;
              historicoContainer.appendChild(successMsg);
              
              // Refresh after 2 seconds
              setTimeout(() => {
                fetchVelas();
              }, 2000);
            }
          } catch (e) {
            console.error("‚ùå Exception deleting history:", e);
            alert("Erro ao excluir hist√≥rico: " + e.message);
          } finally {
            // Re-enable button
            modalConfirmBtn.disabled = false;
            modalConfirmBtn.innerHTML = '<span>üóëÔ∏è</span><span>Confirmar Exclus√£o</span>';
          }
        });

        // Fetch inicial
        loadingElement.classList.remove('hidden');
        fetchVelas();
        
        // Atualizar a cada 1 segundo
        setInterval(fetchVelas, 1000);
      });
    </script>
  </body>
</html>
