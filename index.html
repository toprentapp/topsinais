<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Top Sinais - Aviator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úàÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
      
      * {
        font-family: 'Inter', sans-serif;
      }
      
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
      }
      
      .glass-effect {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .vela-card {
        position: relative;
        overflow: visible;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      
      .vela-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      }
      
      .vela-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }
      
      .vela-card:hover::before {
        transform: translateX(100%);
      }
      
      .highlight {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
        color: #000 !important;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5) !important;
      }
      
      .dimmed {
        opacity: 0.6;
        filter: brightness(0.8);
      }
      
      .next-rosa {
        opacity: 1 !important;
        filter: brightness(1) !important;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
        border: 2px solid #ec4899;
      }
      
      .vela-rosa {
        background: linear-gradient(135deg, #ec4899 0%, #d00f70 100%);
        color: white;
      }
      
      .vela-roxa {
        background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        color: white;
      }
      
      .vela-azul {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
      }
      
      .vela-cinza {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
      }
      
      .vela-gatilho-atual {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%) !important;
        animation: pulse-orange 2s infinite;
        border: 2px solid #ff8c00 !important;
      }
      
      .numero-vela {
        font-size: 1rem;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      
      .horario-vela {
        font-size: 9px;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 0.15rem;
      }
      
      .header-gradient {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: .7;
        }
      }
      
      .custom-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a5b4fc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
      
      .interval-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        z-index: 20;
      }
      
      .interval-badge.before-rosa {
        border: 2px solid #ec4899;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.8);
      }
      
      @media (max-width: 640px) {
        .numero-vela {
          font-size: 0.85rem;
        }
        .horario-vela {
          font-size: 7.7px;
        }
      }
      
      /* Estilos para painel de padr√µes */
      .padroes-panel {
        position: fixed;
        right: 20px;
        top: 20px;
        width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000;
      }
      
      .padrao-card {
        transition: all 0.3s ease;
      }
      
      .padrao-card:hover {
        transform: translateX(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }
      
      .gatilho-atual {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%) !important;
        animation: pulse-orange 2s infinite;
      }
      
      @keyframes pulse-orange {
        0%, 100% {
          box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 140, 0, 0.8);
        }
      }
      
      @media (max-width: 1024px) {
        .padroes-panel {
          position: relative;
          right: auto;
          top: auto;
          width: 100%;
          max-height: none;
          margin-bottom: 20px;
        }
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">
      <!-- Header -->
      <div class="glass-effect rounded-2xl p-6 sm:p-8 mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-center mb-2 header-gradient">
          üöÄ Top Sinais - Aviator
        </h1>
        <p class="text-center text-gray-400 text-sm sm:text-base">
          Hist√≥rico de velas em tempo real
        </p>
      </div>

      <!-- Selectors -->
      <div class="glass-effect rounded-2xl p-4 sm:p-6 mb-6 space-y-4">
        <div>
          <label for="casa-selector" class="block mb-3 text-sm sm:text-base font-semibold text-gray-300">
            üè† Selecione a Casa
          </label>
          <select
            id="casa-selector"
            class="custom-select glass-effect border border-indigo-500/30 text-white text-sm sm:text-base rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block w-full p-3 sm:p-4 transition-all cursor-pointer"
          >
            <option value="br4betcom">BR4BET</option>
            <option value="openbox">OpenBox</option>
            <option value="Jetx-ApostaTudo">Jetx - Aposta tudo</option>
             <option value="Jetx-Realsbet">Jetx - Realsbet</option>
          </select>
        </div>
        
        <div>
          <label for="color-filter" class="block mb-3 text-sm sm:text-base font-semibold text-gray-300">
            üé® Filtrar por Cor
          </label>
          <select
            id="color-filter"
            class="custom-select glass-effect border border-indigo-500/30 text-white text-sm sm:text-base rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block w-full p-3 sm:p-4 transition-all cursor-pointer"
          >
            <option value="all">Todas as Cores</option>
            <option value="rosa">üå∏ Rosas (‚â•10x)</option>
            <option value="roxa">üíú Roxas</option>
            <option value="azul">üíô Azuis</option>
          </select>
        </div>

        <div class="flex items-center justify-between p-4 glass-effect border border-indigo-500/30 rounded-xl">
          <div>
            <label for="interval-toggle" class="text-sm sm:text-base font-semibold text-gray-300 cursor-pointer">
              üìä Marcar Intervalos Rosa
            </label>
            <p class="text-xs text-gray-500 mt-1">Numera velas ap√≥s cada rosa</p>
          </div>
          <button
            id="interval-toggle"
            role="switch"
            aria-checked="false"
            class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600"
          >
            <span class="translate-x-1 inline-block h-5 w-5 transform rounded-full bg-white transition-transform"></span>
          </button>
        </div>

        <div class="mt-4">
          <button
            id="reset-api-btn"
            class="w-full px-4 py-3 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
          >
            <span>üîÑ</span>
            <span>Resetar Navegador API</span>
          </button>
        </div>
      </div>

      <!-- Status Badge -->
      <div class="flex justify-center mb-6">
        <div class="glass-effect rounded-full px-4 sm:px-6 py-2 flex items-center gap-2">
          <div class="w-2 h-2 bg-green-500 rounded-full pulse-animation"></div>
          <span class="text-xs sm:text-sm font-medium text-gray-300">Conectado</span>
        </div>
      </div>

      <!-- An√°lise de Antecessores -->
      <div id="analise-antecessores" class="glass-effect rounded-xl p-3 mb-6 max-h-[200px] overflow-y-auto">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üìä Antecessores de Rosa:</span>
          <div id="antecessores-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando an√°lise...</span>
          </div>
        </div>
      </div>

      <!-- Antecessores Recentes -->
      <div id="antecessores-recentes" class="glass-effect rounded-xl p-3 mb-6">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üî• √öltimos 10 Antecessores (‚â•6x):</span>
          <div id="antecessores-recentes-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando...</span>
          </div>
        </div>
      </div>

      <!-- Antecessores PRO -->
      <div id="antecessores-pro" class="glass-effect rounded-xl p-3 mb-6 border-2 border-purple-500/50">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">‚≠ê Antecessores PRO (8x - 9.99x):</span>
          <div id="antecessores-pro-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando...</span>
          </div>
        </div>
      </div>

      <!-- Painel de Padr√µes Mapeados -->
      <div id="padroes-panel" class="padroes-panel glass-effect rounded-2xl p-4 lg:block">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
          <span>üéØ</span>
          <span>Padr√µes Mapeados</span>
        </h3>
        <div id="padroes-list" class="space-y-3">
          <p class="text-gray-400 text-sm">Nenhum padr√£o detectado ainda...</p>
        </div>
      </div>

      <!-- Grid de Velas -->
      <div id="historico-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-2 sm:gap-2.5">
        <!-- As velas ser√£o inseridas aqui -->
      </div>

      <!-- Loading State -->
      <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-400">Carregando velas...</p>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_URL = "https://aviator.pix24h.online/historico";

        const casaSelector = document.getElementById("casa-selector");
        const colorFilter = document.getElementById("color-filter");
        const intervalToggle = document.getElementById("interval-toggle");
        const historicoContainer = document.getElementById("historico-container");
        const loadingElement = document.getElementById("loading");
        const padroesPanel = document.getElementById("padroes-panel");
        const padroesList = document.getElementById("padroes-list");
        let selectedNumber = null;
        let selectedColorFilter = "all";
        let showIntervals = false;
        let padroesDetectados = [];

        // Fun√ß√µes de LocalStorage
        function salvarPadroesNoStorage(padroes) {
          try {
            localStorage.setItem('padroesDetectados', JSON.stringify(padroes));
          } catch (error) {
            console.error('Erro ao salvar padr√µes no localStorage:', error);
          }
        }

        function carregarPadroesDoStorage() {
          try {
            const padroes = localStorage.getItem('padroesDetectados');
            return padroes ? JSON.parse(padroes) : [];
          } catch (error) {
            console.error('Erro ao carregar padr√µes do localStorage:', error);
            return [];
          }
        }

        // Carregar padr√µes salvos ao iniciar
        padroesDetectados = carregarPadroesDoStorage();

        // Fun√ß√£o para detectar padr√µes (vela >= 5x com 2 antecessores < 2x)
        function detectarPadroes(velas) {
          const novosPadroes = [];
          
          // Percorre as velas DA MAIS ANTIGA PARA A MAIS RECENTE
          for (let i = velas.length - 1; i >= 0; i--) {
            const velaGatilho = velas[i];
            const numeroGatilho = parseFloat(velaGatilho.numero);
            
            // Verifica se √© uma vela >= 5x
            if (numeroGatilho >= 5) {
              // Verifica se temos pelo menos 2 velas anteriores
              if (i + 2 < velas.length) {
                const antecessor1 = velas[i + 1]; // 1¬™ antecessora (sem restri√ß√£o)
                const antecessor2 = velas[i + 2]; // 2¬™ antecessora (gatilho - deve ser < 2x)
                
                const numAnt1 = parseFloat(antecessor1.numero);
                const numAnt2 = parseFloat(antecessor2.numero);
                
                // Verifica APENAS se a 2¬™ antecessora √© < 2x (gatilho)
                // A 1¬™ antecessora pode ter qualquer valor
                if (numAnt2 < 2) {
                  // Cria ID √∫nico para o padr√£o baseado no gatilho (2¬™ antecessora)
                  const padraoId = `${velaGatilho.horario}-${numeroGatilho.toFixed(2)}`;
                  
                  // Verifica se j√° existe
                  const jaExiste = padroesDetectados.some(p => p.id === padraoId);
                  
                  if (!jaExiste) {
                    // Verifica se √© a primeira ou segunda ocorr√™ncia deste gatilho
                    const gatilhoNumero = numAnt2.toFixed(2);
                    const ocorrenciasAnteriores = padroesDetectados.filter(p => 
                      p.antecessor2.numero === gatilhoNumero
                    ).length;
                    
                    const padrao = {
                      id: padraoId,
                      velaGatilho: {
                        numero: numeroGatilho.toFixed(2),
                        horario: velaGatilho.horario
                      },
                      antecessor1: {
                        numero: numAnt1.toFixed(2),
                        horario: antecessor1.horario
                      },
                      antecessor2: {
                        numero: numAnt2.toFixed(2),
                        horario: antecessor2.horario
                      },
                      wins: 0,
                      losses: 0,
                      timestamp: Date.now(),
                      isPrimeiraOcorrencia: ocorrenciasAnteriores === 0
                    };
                    
                    novosPadroes.push(padrao);
                  }
                }
              }
            }
          }
          
          // Adiciona novos padr√µes aos existentes (invertendo para manter ordem cronol√≥gica)
          if (novosPadroes.length > 0) {
            padroesDetectados = [...novosPadroes.reverse(), ...padroesDetectados];
            // Limita a 50 padr√µes mais recentes
            padroesDetectados = padroesDetectados.slice(0, 50);
            salvarPadroesNoStorage(padroesDetectados);
          }
          
          return padroesDetectados;
        }

        // Fun√ß√£o para atualizar resultados dos padr√µes
        function atualizarResultadosPadroes(velas) {
          let atualizado = false;
          
          padroesDetectados.forEach(padrao => {
            // Se j√° tem resultado, pula
            if (padrao.resultado) return;
            
            // Se √© a primeira ocorr√™ncia, n√£o marca Win/Loss ainda
            if (padrao.isPrimeiraOcorrencia) {
              // Apenas marca como "mapeado" mas n√£o calcula resultado
              return;
            }
            
            // Procura o padr√£o nas velas
            for (let i = 0; i < velas.length; i++) {
              const vela = velas[i];
              const numero = parseFloat(vela.numero).toFixed(2);
              const horario = vela.horario;
              
              // Encontrou a vela gatilho do padr√£o
              if (numero === padrao.velaGatilho.numero && horario === padrao.velaGatilho.horario) {
                // Verifica se h√° uma vela ap√≥s o gatilho (resultado da entrada)
                if (i > 0) {
                  const velaResultado = velas[i - 1];
                  const numResultado = parseFloat(velaResultado.numero);
                  
                  // Se a pr√≥xima vela √© >= 5x, √© WIN
                  if (numResultado >= 5) {
                    padrao.wins = 1;
                    padrao.resultado = 'win';
                    atualizado = true;
                  } else {
                    // Se passou mais de 1 vela e n√£o deu win, √© LOSS
                    padrao.losses = 1;
                    padrao.resultado = 'loss';
                    atualizado = true;
                  }
                }
                break;
              }
            }
          });
          
          if (atualizado) {
            salvarPadroesNoStorage(padroesDetectados);
          }
        }

        // Fun√ß√£o para renderizar padr√µes no painel
        function renderizarPadroes(velas) {
          if (padroesDetectados.length === 0) {
            padroesList.innerHTML = '<p class="text-gray-400 text-sm">Nenhum padr√£o detectado ainda...</p>';
            return;
          }
          
          // Pega a vela atual (mais recente)
          const velaAtual = velas.length > 0 ? parseFloat(velas[0].numero).toFixed(2) : null;
          
          // Ordena padr√µes: vela atual primeiro, depois os demais por timestamp
          const padroesOrdenados = [...padroesDetectados].sort((a, b) => {
            const aIsAtual = velaAtual === a.antecessor2.numero;
            const bIsAtual = velaAtual === b.antecessor2.numero;
            
            if (aIsAtual && !bIsAtual) return -1;
            if (!aIsAtual && bIsAtual) return 1;
            return b.timestamp - a.timestamp;
          });
          
          padroesList.innerHTML = padroesOrdenados.map(padrao => {
            const isGatilhoAtual = velaAtual === padrao.antecessor2.numero;
            const cardClass = isGatilhoAtual ? 'gatilho-atual' : '';
            
            let statusBadge = '';
            if (padrao.resultado === 'win') {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-green-500 text-white rounded">‚úì WIN</span>';
            } else if (padrao.resultado === 'loss') {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-red-500 text-white rounded">‚úó LOSS</span>';
            } else if (padrao.isPrimeiraOcorrencia) {
              // Primeira ocorr√™ncia - apenas mapeado
              if (isGatilhoAtual) {
                statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-orange-500 text-black rounded animate-pulse">üî• VELA ATUAL</span>';
              } else {
                statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-blue-600 text-white rounded">üìç MAPEADO</span>';
              }
            } else if (isGatilhoAtual) {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-orange-500 text-black rounded animate-pulse">üî• VELA ATUAL</span>';
            } else {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-gray-600 text-white rounded">‚è≥ Aguardando</span>';
            }
            
            return `
              <div class="padrao-card glass-effect rounded-xl p-3 border border-indigo-500/30 ${cardClass}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-semibold text-gray-400">Padr√£o Detectado</span>
                  ${statusBadge}
                </div>
                
                <div class="space-y-2">
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">Gatilho (2¬™ Ant.):</span>
                    <span class="font-bold text-blue-400">${padrao.antecessor2.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.antecessor2.horario}</span>
                  </div>
                  
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">1¬™ Antecessora:</span>
                    <span class="font-bold text-purple-400">${padrao.antecessor1.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.antecessor1.horario}</span>
                  </div>
                  
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">Vela ‚â•5x:</span>
                    <span class="font-bold text-pink-400">${padrao.velaGatilho.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.velaGatilho.horario}</span>
                  </div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-gray-700 flex items-center justify-between text-xs">
                  <div class="flex gap-3">
                    <span class="text-green-400 font-semibold">‚úì ${padrao.wins} Win${padrao.wins !== 1 ? 's' : ''}</span>
                    <span class="text-red-400 font-semibold">‚úó ${padrao.losses} Loss${padrao.losses !== 1 ? 'es' : ''}</span>
                  </div>
                  ${padrao.wins + padrao.losses > 0 ? `
                    <span class="text-gray-400">
                      ${((padrao.wins / (padrao.wins + padrao.losses)) * 100).toFixed(0)}% Acerto
                    </span>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        }

        // Fun√ß√£o para converter dados da API para o formato esperado
        function convertApiDataToVelas(apiData) {
          return apiData.map(item => {
            const numero = parseFloat(item.result.replace('x', '').replace(',', '.'));
            let cor = 'cinza';
            
            // Define a cor baseada no valor
            if (numero >= 10) {
              cor = 'rosa';
            } else if (numero >= 2) {
              cor = 'roxa';
            } else {
              cor = 'azul';
            }
            
            return {
              numero: numero,
              horario: item.time,
              cor: cor,
              result: item.result,
              fullDate: item.fullDate || item.time
            };
          });
        }

        async function fetchVelas() {
          try {
            const response = await fetch(API_URL);
            const apiResponse = await response.json();

            if (apiResponse.success && apiResponse.data && apiResponse.data.length > 0) {
              const velas = convertApiDataToVelas(apiResponse.data);
              renderVelas(velas);
            } else {
              console.log("‚ö†Ô∏è Nenhum dado dispon√≠vel da API");
              historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-gray-400">Aguardando dados da API...</p></div>';
            }
          } catch (error) {
            console.error("‚ùå Erro ao buscar velas da API:", error);
            historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-red-400">Erro ao conectar com a API. Verifique se o servidor est√° rodando.</p></div>';
          }
        }

        function getVelaClass(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "vela-rosa";
          }
          if (vela.cor === "roxa") {
            return "vela-roxa";
          }
          if (vela.cor === "azul") {
            return "vela-azul";
          }
          return "vela-cinza";
        }

        function getVelaType(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "rosa";
          }
          return vela.cor;
        }

        function shouldShowVela(velaType) {
          if (selectedColorFilter === "all") return true;
          return velaType === selectedColorFilter;
        }

        function analisarAntecessores(velas) {
          const antecessoresMap = new Map();
          const totalAparicoesMap = new Map();
          
          // Verifica se as primeiras 100 velas (mais recentes) n√£o t√™m nenhuma rosa
          let temRosaNas20Primeiras = false;
          for (let i = 0; i < Math.min(100, velas.length); i++) {
            const isRosa = parseFloat(velas[i].numero) >= 10;
            if (isRosa) {
              temRosaNas20Primeiras = true;
              break;
            }
          }
          
          // Se n√£o h√° rosa nas √∫ltimas 100 velas E temos pelo menos 100 velas, ignora os padr√µes anteriores
          if (!temRosaNas20Primeiras && velas.length >= 100) {
            return [];
          }
          
          // Conta todas as apari√ß√µes de cada n√∫mero
          velas.forEach(vela => {
            const numero = parseFloat(vela.numero).toFixed(2);
            totalAparicoesMap.set(numero, (totalAparicoesMap.get(numero) || 0) + 1);
          });
          
          // Percorre todas as velas para encontrar rosas e seus antecessores
          for (let i = 0; i < velas.length; i++) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              // Verifica at√© 2 casas antes
              for (let j = 1; j <= 2; j++) {
                if (i + j < velas.length) {
                  const antecessor = velas[i + j];
                  const antecessorNumero = parseFloat(antecessor.numero).toFixed(2);
                  
                  if (!antecessoresMap.has(antecessorNumero)) {
                    antecessoresMap.set(antecessorNumero, { 
                      acertos: 0, 
                      positions: [],
                      totalAparicoes: totalAparicoesMap.get(antecessorNumero) || 0
                    });
                  }
                  
                  const data = antecessoresMap.get(antecessorNumero);
                  data.acertos++;
                  data.positions.push(j);
                }
              }
            }
          }
          
          // Pega as duas velas mais recentes (posi√ß√µes 1 e 2)
          const velasAtuais = new Set();
          if (velas.length >= 1) velasAtuais.add(parseFloat(velas[0].numero).toFixed(2));
          if (velas.length >= 2) velasAtuais.add(parseFloat(velas[1].numero).toFixed(2));
          
          // Filtra apenas antecessores com pelo menos 3 apari√ß√µes totais
          // E probabilidade m√≠nima de 20% para garantir lucro saindo em 5x
          const antecessoresRelevantes = Array.from(antecessoresMap.entries())
            .filter(([numero, data]) => data.totalAparicoes >= 3)
            .map(([numero, data]) => {
              const erros = data.totalAparicoes - data.acertos;
              const probabilidade = ((data.acertos / data.totalAparicoes) * 100).toFixed(1);
              const isAtual = velasAtuais.has(numero);
              
              return {
                numero,
                acertos: data.acertos,
                erros,
                totalAparicoes: data.totalAparicoes,
                probabilidade,
                positions: data.positions,
                isAtual
              };
            })
            .filter(data => parseFloat(data.probabilidade) >= 20) // M√≠nimo 20% para lucro
            .sort((a, b) => parseFloat(b.probabilidade) - parseFloat(a.probabilidade))
            .slice(0, 10); // Limita aos top 10
          
          return antecessoresRelevantes;
        }
        
        function renderAnalisesAntecessores(antecessores) {
          const antecessoresList = document.getElementById('antecessores-list');
          
          if (antecessores.length === 0) {
            antecessoresList.innerHTML = '<span class="text-gray-500">Nenhum padr√£o lucrativo encontrado (m√≠n. 3 apari√ß√µes e 20% de acerto para lucro saindo em 5x)</span>';
            return;
          }
          
          antecessoresList.innerHTML = antecessores.map(data => {
            const posicoes = {};
            data.positions.forEach(pos => {
              posicoes[pos] = (posicoes[pos] || 0) + 1;
            });
            
            const detalhes = Object.entries(posicoes)
              .map(([pos, count]) => `${count}x na ${pos}¬™ casa`)
              .join(', ');
            
            // Define cor da probabilidade
            let probColor = 'text-gray-400';
            const prob = parseFloat(data.probabilidade);
            if (prob >= 70) probColor = 'text-green-400';
            else if (prob >= 50) probColor = 'text-yellow-400';
            else if (prob >= 30) probColor = 'text-orange-400';
            else probColor = 'text-red-400';
            
            // Badge de vela atual
            const atualBadge = data.isAtual 
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded">ATUAL</span>' 
              : '';
            
            return `
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-pink-500/20 to-purple-500/20 border border-pink-500/30">
                ${atualBadge}
                <span class="font-bold text-pink-400">${data.numero}x</span>
                <span class="text-gray-400">‚Üí</span>
                <span class="${probColor} font-bold text-sm">${data.probabilidade}%</span>
                <span class="text-gray-500 text-xs">|</span>
                <span class="text-green-400 font-semibold text-xs">${data.acertos}‚úì</span>
                <span class="text-red-400 font-semibold text-xs">${data.erros}‚úó</span>
                <span class="text-gray-500 text-xs">(${detalhes})</span>
              </span>
            `;
          }).join('');
        }

        function extrairAntecessoresRecentes(velas) {
          const antecessoresRecentes = [];
          const antecessoresPro = [];
          
          // Percorre as velas mais recentes para encontrar gatilhos >= 6x
          for (let i = 0; i < velas.length; i++) {
            const vela = velas[i];
            const numero = parseFloat(vela.numero);
            const isGatilho = numero >= 6; // Gatilho: velas >= 6x
            
            if (isGatilho) {
              // Pega os antecessores (1¬™ e 2¬™ casa antes do gatilho)
              const antecessoresDaVela = [];
              
              if (i + 1 < velas.length) {
                const antNum = parseFloat(velas[i + 1].numero);
                // S√≥ adiciona se for < 2x
                if (antNum < 2) {
                  antecessoresDaVela.push({
                    numero: antNum.toFixed(2),
                    posicao: 1,
                    horario: velas[i + 1].horario,
                    cor: velas[i + 1].cor,
                    gatilho: numero.toFixed(2)
                  });
                }
              }
              
              if (i + 2 < velas.length) {
                const antNum = parseFloat(velas[i + 2].numero);
                // S√≥ adiciona se for < 2x
                if (antNum < 2) {
                  antecessoresDaVela.push({
                    numero: antNum.toFixed(2),
                    posicao: 2,
                    horario: velas[i + 2].horario,
                    cor: velas[i + 2].cor,
                    gatilho: numero.toFixed(2)
                  });
                }
              }
              
              // Adiciona aos arrays apropriados
              antecessoresDaVela.forEach(ant => {
                const num = parseFloat(ant.numero);
                const gatilhoNum = parseFloat(ant.gatilho);
                
                // Antecessores PRO (quando o gatilho √© 8x a 9.99x)
                if (gatilhoNum >= 8 && gatilhoNum < 10 && antecessoresPro.length < 10) {
                  antecessoresPro.push(ant);
                }
                
                // Antecessores normais (gatilho >= 6x)
                if (antecessoresRecentes.length < 10) {
                  antecessoresRecentes.push(ant);
                }
              });
              
              // Para quando ambos os arrays estiverem cheios
              if (antecessoresRecentes.length >= 10 && antecessoresPro.length >= 10) {
                break;
              }
            }
          }
          
          return { antecessoresRecentes, antecessoresPro };
        }

        function renderAntecessoresRecentes(antecessoresData) {
          const antecessoresRecentesList = document.getElementById('antecessores-recentes-list');
          const antecessoresProList = document.getElementById('antecessores-pro-list');
          
          // Pega as duas velas mais recentes para verificar se s√£o atuais
          const velasAtuais = new Set();
          if (window.velasGlobais && window.velasGlobais.length >= 1) {
            velasAtuais.add(parseFloat(window.velasGlobais[0].numero).toFixed(2));
          }
          if (window.velasGlobais && window.velasGlobais.length >= 2) {
            velasAtuais.add(parseFloat(window.velasGlobais[1].numero).toFixed(2));
          }
          
          // Renderiza Antecessores Normais (>= 6x)
          if (antecessoresData.antecessoresRecentes.length === 0) {
            antecessoresRecentesList.innerHTML = '<span class="text-gray-500">Nenhum antecessor ‚â•6x encontrado</span>';
          } else {
            antecessoresRecentesList.innerHTML = antecessoresData.antecessoresRecentes.map(item => {
              const isAtual = velasAtuais.has(item.numero);
              const num = parseFloat(item.numero);
              
              // Define cor baseada no valor
              let bgClass, textClass, emoji;
              if (num >= 8 && num < 10) {
                // PRO (8-9.99x)
                bgClass = isAtual 
                  ? 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30' 
                  : 'bg-gradient-to-r from-purple-500/20 to-purple-600/20 border-purple-500/30';
                textClass = isAtual ? 'text-pink-400' : 'text-purple-400';
                emoji = '‚≠ê';
              } else if (item.cor === 'azul') {
                // Azul
                bgClass = isAtual 
                  ? 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30' 
                  : 'bg-gradient-to-r from-blue-500/20 to-blue-600/20 border-blue-500/30';
                textClass = isAtual ? 'text-pink-400' : 'text-blue-400';
                emoji = 'üíô';
              } else if (item.cor === 'roxa') {
                // Roxa
                bgClass = isAtual 
                  ? 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30' 
                  : 'bg-gradient-to-r from-purple-400/20 to-purple-500/20 border-purple-400/30';
                textClass = isAtual ? 'text-pink-400' : 'text-purple-300';
                emoji = 'üíú';
              } else {
                // Cinza
                bgClass = isAtual 
                  ? 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30' 
                  : 'bg-gradient-to-r from-gray-500/20 to-gray-600/20 border-gray-500/30';
                textClass = isAtual ? 'text-pink-400' : 'text-gray-400';
                emoji = '‚ö™';
              }
              
              const atualBadge = isAtual 
                ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded">ATUAL</span>' 
                : '';
              
              return `
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg ${bgClass} border">
                  ${atualBadge}
                  <span class="font-bold ${textClass}">${emoji} ${item.numero}x</span>
                </span>
              `;
            }).join('');
          }
          
          // Renderiza Antecessores PRO (8x - 9.99x)
          if (antecessoresData.antecessoresPro.length === 0) {
            antecessoresProList.innerHTML = '<span class="text-gray-500">Nenhum antecessor PRO encontrado</span>';
          } else {
            antecessoresProList.innerHTML = antecessoresData.antecessoresPro.map(item => {
              const isAtual = velasAtuais.has(item.numero);
              
              const bgClass = isAtual 
                ? 'bg-gradient-to-r from-yellow-500/30 to-orange-500/30 border-yellow-500/50' 
                : 'bg-gradient-to-r from-purple-500/30 to-pink-500/30 border-purple-500/50';
              
              const textClass = isAtual ? 'text-yellow-300' : 'text-purple-300';
              
              const atualBadge = isAtual 
                ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded animate-pulse">ATUAL</span>' 
                : '';
              
              return `
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg ${bgClass} border-2 shadow-lg">
                  ${atualBadge}
                  <span class="font-bold ${textClass}">‚≠ê ${item.numero}x</span>
                </span>
              `;
            }).join('');
          }
        }

        function renderVelas(velas) {
          loadingElement.classList.add('hidden');
          historicoContainer.innerHTML = "";
          
          // Armazena velas globalmente para uso em outras fun√ß√µes
          window.velasGlobais = velas;
          
          // Analisa antecessores
          const antecessores = analisarAntecessores(velas);
          renderAnalisesAntecessores(antecessores);
          
          // Extrai e renderiza antecessores recentes e PRO
          const antecessoresData = extrairAntecessoresRecentes(velas);
          renderAntecessoresRecentes(antecessoresData);
          
          // Detecta novos padr√µes
          detectarPadroes(velas);
          
          // Atualiza resultados dos padr√µes existentes
          atualizarResultadosPadroes(velas);
          
          // Renderiza padr√µes no painel
          renderizarPadroes(velas);
          
          // Primeiro, calcular os intervalos percorrendo do mais antigo para o mais recente
          const velasComIntervalo = [];
          let intervalCount = 0;
          let countingInterval = false;
          
          // Percorre do final para o in√≠cio (mais antigo para mais recente)
          for (let i = velas.length - 1; i >= 0; i--) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              countingInterval = true;
              intervalCount = 0;
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            } else if (countingInterval) {
              intervalCount++;
              velasComIntervalo.unshift({ vela, intervalo: intervalCount });
            } else {
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            }
          }
          
          // Pega vela atual para marcar gatilhos em laranja
          const velaAtual = velas.length > 0 ? parseFloat(velas[0].numero).toFixed(2) : null;
          
          // Verifica quais velas s√£o gatilhos atuais
          const gatilhosAtuais = new Set();
          padroesDetectados.forEach(padrao => {
            if (velaAtual === padrao.antecessor2.numero) {
              gatilhosAtuais.add(padrao.antecessor2.numero);
            }
          });
          
          // Agora renderiza as velas com os intervalos corretos
          velasComIntervalo.forEach(({ vela, intervalo }, index) => {
            const velaElement = document.createElement("div");
            const numero = parseFloat(vela.numero).toFixed(2);
            const horario = formatDate(vela.horario);
            const velaType = getVelaType(vela);
            const isRosa = parseFloat(vela.numero) >= 10;
            
            // Verifica se √© um gatilho atual
            const isGatilhoAtual = gatilhosAtuais.has(numero);
            
            // Verifica se a pr√≥xima vela √© rosa (√∫ltima antes da rosa)
            const isBeforeRosa = index > 0 && parseFloat(velasComIntervalo[index - 1].vela.numero) >= 10;
            const badgeClass = isBeforeRosa ? 'interval-badge before-rosa' : 'interval-badge';
            
            const intervalBadge = showIntervals && !isRosa && intervalo > 0
              ? `<div class="${badgeClass}">${intervalo}</div>`
              : '';
            
            velaElement.innerHTML = `
              ${intervalBadge}
              <div class="numero-vela">${numero}x</div>
              <div class="horario-vela">${horario}</div>
            `;
            
            velaElement.dataset.numero = numero;
            velaElement.dataset.type = velaType;
            velaElement.className = `vela-card p-2 sm:p-2.5 rounded-xl text-center cursor-pointer ${getVelaClass(vela)}`;
            
            // Aplica marca√ß√£o laranja se for gatilho atual
            if (isGatilhoAtual) {
              velaElement.classList.add('vela-gatilho-atual');
            }

            // Aplica filtro de cor
            if (!shouldShowVela(velaType)) {
              velaElement.classList.add("dimmed");
            }

            if (selectedNumber && velaElement.dataset.numero === selectedNumber) {
              velaElement.classList.add("highlight");
            } else if (selectedNumber) {
              velaElement.classList.add("dimmed");
            }

            historicoContainer.appendChild(velaElement);
          });
          
          // Aplica o destaque nas velas rosas ap√≥s selecionadas
          if (selectedNumber) {
            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              if (velaDiv.dataset.numero === selectedNumber && index > 0) {
                const nextVela = allVelas[index - 1];
                const nextNumero = parseFloat(nextVela.dataset.numero);
                if (nextNumero >= 10) {
                  nextVela.classList.remove("dimmed");
                  nextVela.classList.add("next-rosa");
                }
              }
            });
          }
        }

        function handleVelaClick(event) {
          const target = event.target.closest('.vela-card');
          if (target && target.dataset.numero) {
            const clickedNumber = target.dataset.numero;

            if (selectedNumber === clickedNumber) {
              selectedNumber = null;
            } else {
              selectedNumber = clickedNumber;
            }

            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              velaDiv.classList.remove("highlight", "dimmed", "next-rosa");
              
              if (selectedNumber) {
                // Se o n√∫mero atual √© o selecionado, destaca
                if (velaDiv.dataset.numero === selectedNumber) {
                  velaDiv.classList.add("highlight");
                  
                  // Verifica se a pr√≥xima vela √© rosa (>= 10)
                  if (index > 0) {
                    const nextVela = allVelas[index - 1];
                    const nextNumero = parseFloat(nextVela.dataset.numero);
                    if (nextNumero >= 10) {
                      nextVela.classList.remove("dimmed");
                      nextVela.classList.add("next-rosa");
                    }
                  }
                } else {
                  // Escurece as outras velas
                  velaDiv.classList.add("dimmed");
                }
              }
            });
          }
        }

        casaSelector.addEventListener("change", () => {
          selectedNumber = null;
          loadingElement.classList.remove('hidden');
          fetchVelas();
        });

        colorFilter.addEventListener("change", () => {
          selectedColorFilter = colorFilter.value;
          selectedNumber = null;
          fetchVelas();
        });

        intervalToggle.addEventListener("click", () => {
          showIntervals = !showIntervals;
          intervalToggle.setAttribute("aria-checked", showIntervals);
          
          if (showIntervals) {
            intervalToggle.classList.remove("bg-gray-600");
            intervalToggle.classList.add("bg-indigo-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-1");
            intervalToggle.querySelector("span").classList.add("translate-x-6");
          } else {
            intervalToggle.classList.remove("bg-indigo-600");
            intervalToggle.classList.add("bg-gray-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-6");
            intervalToggle.querySelector("span").classList.add("translate-x-1");
          }
          
          fetchVelas();
        });

        historicoContainer.addEventListener("click", handleVelaClick);

        // Fun√ß√£o para formatar hor√°rio da API (formato: "HH:MM")
        function formatDate(timeString) {
          // A API retorna apenas "HH:MM", ent√£o vamos adicionar a data atual
          const now = new Date();
          const [hours, minutes] = timeString.split(':');
          const date = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hours), parseInt(minutes));
          
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          const hrs = String(date.getHours()).padStart(2, '0');
          const mins = String(date.getMinutes()).padStart(2, '0');
          
          return `${day}/${month}/${year} - ${hrs}:${mins}`;
        }

        // Bot√£o de resetar API
        const resetApiBtn = document.getElementById("reset-api-btn");
        if (resetApiBtn) {
          resetApiBtn.addEventListener("click", async () => {
            const originalText = resetApiBtn.innerHTML;
            resetApiBtn.disabled = true;
            resetApiBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></span><span>Resetando...</span>';
            
            try {
              const response = await fetch('https://aviator.pix24h.online/reset');
              const data = await response.json();
              
              if (data.success) {
                console.log("‚úÖ Navegador resetado com sucesso");
                historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-green-400">‚úÖ Navegador resetado! Aguardando novos dados...</p></div>';
                
                // Aguarda 3 segundos e recarrega
                setTimeout(() => {
                  fetchVelas();
                }, 3000);
              } else {
                console.error("‚ùå Erro ao resetar:", data.error);
                alert("Erro ao resetar navegador: " + (data.error || "Erro desconhecido"));
              }
            } catch (error) {
              console.error("‚ùå Erro ao chamar endpoint de reset:", error);
              alert("Erro ao conectar com o servidor. Verifique se est√° rodando.");
            } finally {
              resetApiBtn.disabled = false;
              resetApiBtn.innerHTML = originalText;
            }
          });
        }

        // Fetch inicial
        loadingElement.classList.remove('hidden');
        fetchVelas();
        
        // Atualizar a cada 1 segundo
        setInterval(fetchVelas, 1000);
      });
    </script>
  </body>
</html>
