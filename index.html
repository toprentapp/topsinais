<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Top Sinais - Aviator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚úàÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
      
      * {
        font-family: 'Inter', sans-serif;
      }
      
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        min-height: 100vh;
      }
      
      .glass-effect {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .vela-card {
        position: relative;
        overflow: visible;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }
      
      .vela-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      }
      
      .vela-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
      }
      
      .vela-card:hover::before {
        transform: translateX(100%);
      }
      
      .highlight {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%) !important;
        color: #000 !important;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.5) !important;
      }
      
      .dimmed {
        opacity: 0.6;
        filter: brightness(0.8);
      }
      
      .next-rosa {
        opacity: 1 !important;
        filter: brightness(1) !important;
        box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
        border: 2px solid #ec4899;
      }
      
      .vela-rosa {
        background: linear-gradient(135deg, #ec4899 0%, #d00f70 100%);
        color: white;
      }
      
      .vela-roxa {
        background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        color: white;
      }
      
      .vela-azul {
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        color: white;
      }
      
      .vela-cinza {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
      }
      
      .vela-gatilho-atual {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%) !important;
        animation: pulse-orange 2s infinite;
        border: 2px solid #ff8c00 !important;
      }
      
      .vela-decimal-mapeado {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
        animation: pulse-green 2s infinite;
        border: 2px solid #22c55e !important;
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.6) !important;
      }
      
      .numero-vela {
        font-size: 1rem;
        font-weight: 800;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      
      .horario-vela {
        font-size: 9px;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 0.15rem;
      }
      
      .header-gradient {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      
      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: .7;
        }
      }
      
      .custom-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a5b4fc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
      }
      
      .interval-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        z-index: 20;
      }
      
      .interval-badge.before-rosa {
        border: 2px solid #ec4899;
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.8);
      }
      
      @media (max-width: 640px) {
        .numero-vela {
          font-size: 0.85rem;
        }
        .horario-vela {
          font-size: 7.7px;
        }
      }
      
      /* Estilos para painel de padr√µes */
      .padroes-panel {
        position: fixed;
        right: 20px;
        top: 20px;
        width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      
      .padroes-panel.minimized {
        max-height: 60px;
        overflow: hidden;
      }
      
      .padroes-panel.minimized #padroes-list {
        display: none;
      }
      
      .minimize-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
        user-select: none;
      }
      
      .minimize-btn:hover {
        transform: scale(1.1);
      }
      
      .minimize-btn.minimized {
        transform: rotate(180deg);
      }
      
      .padrao-card {
        transition: all 0.3s ease;
      }
      
      .padrao-card:hover {
        transform: translateX(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      }
      
      .gatilho-atual {
        background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%) !important;
        animation: pulse-orange 2s infinite;
      }
      
      @keyframes pulse-orange {
        0%, 100% {
          box-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 140, 0, 0.8);
        }
      }
      
      @keyframes pulse-green {
        0%, 100% {
          box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(34, 197, 94, 0.8);
        }
      }
      
      @media (max-width: 1024px) {
        .padroes-panel {
          position: relative;
          right: auto;
          top: auto;
          width: 100%;
          max-height: none;
          margin-bottom: 20px;
        }
      }
    </style>
  </head>
  <body class="p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto max-w-7xl">
      <!-- Header -->
      <div class="glass-effect rounded-2xl p-6 sm:p-8 mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-center mb-2 header-gradient">
          üöÄ Top Sinais - Aviator
        </h1>
        <p class="text-center text-gray-400 text-sm sm:text-base">
          Hist√≥rico de velas em tempo real
        </p>
      </div>

      <!-- Selectors -->
      <div class="glass-effect rounded-2xl p-4 sm:p-6 mb-6 space-y-4">
        <div class="p-4 glass-effect border border-green-500/30 rounded-xl">
          <div class="flex items-center gap-3">
            <span class="text-2xl">üè†</span>
            <div>
              <p class="text-sm font-semibold text-gray-300">Casa Conectada</p>
              <p class="text-lg font-bold text-green-400">Esportiva.bet</p>
            </div>
          </div>
        </div>
        
        <div>
          <label for="color-filter" class="block mb-3 text-sm sm:text-base font-semibold text-gray-300">
            üé® Filtrar por Cor
          </label>
          <select
            id="color-filter"
            class="custom-select glass-effect border border-indigo-500/30 text-white text-sm sm:text-base rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent block w-full p-3 sm:p-4 transition-all cursor-pointer"
          >
            <option value="all">Todas as Cores</option>
            <option value="rosa">üå∏ Rosas (‚â•10x)</option>
            <option value="roxa">üíú Roxas</option>
            <option value="azul">üíô Azuis</option>
          </select>
        </div>

        <div class="flex items-center justify-between p-4 glass-effect border border-indigo-500/30 rounded-xl">
          <div>
            <label for="interval-toggle" class="text-sm sm:text-base font-semibold text-gray-300 cursor-pointer">
              üìä Marcar Intervalos Rosa
            </label>
            <p class="text-xs text-gray-500 mt-1">Numera velas ap√≥s cada rosa</p>
          </div>
          <button
            id="interval-toggle"
            role="switch"
            aria-checked="false"
            class="relative inline-flex h-7 w-12 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900 bg-gray-600"
          >
            <span class="translate-x-1 inline-block h-5 w-5 transform rounded-full bg-white transition-transform"></span>
          </button>
        </div>

        <div class="mt-4">
          <button
            id="reset-api-btn"
            class="w-full px-4 py-3 bg-gradient-to-r from-orange-600 to-orange-700 hover:from-orange-700 hover:to-orange-800 text-white font-semibold rounded-xl transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-2"
          >
            <span>üîÑ</span>
            <span>Resetar Navegador API</span>
          </button>
        </div>
      </div>

      <!-- Status Badge -->
      <div class="flex justify-center mb-6">
        <div class="glass-effect rounded-full px-4 sm:px-6 py-2 flex items-center gap-2">
          <div class="w-2 h-2 bg-green-500 rounded-full pulse-animation"></div>
          <span class="text-xs sm:text-sm font-medium text-gray-300">Conectado</span>
        </div>
      </div>

      <!-- Card PAGUE/TOME -->
      <div id="mercado-status" class="glass-effect rounded-xl p-3 mb-6 border-2" style="height: 60px;">
        <div class="flex items-center justify-between h-full">
          <div class="flex items-center gap-4">
            <span class="font-semibold text-gray-300 text-sm">üìä Mercado:</span>
            <div id="mercado-badge" class="px-4 py-1.5 rounded-lg font-bold text-sm">
              <span class="text-gray-500">Carregando...</span>
            </div>
          </div>
          <div class="flex items-center gap-4 text-xs">
            <div id="media-roxas" class="flex items-center gap-2">
              <span class="text-gray-400">M√©dia Roxas:</span>
              <span class="font-bold text-purple-400">--</span>
            </div>
            <div id="media-azuis" class="flex items-center gap-2">
              <span class="text-gray-400">M√©dia Azuis <2x:</span>
              <span class="font-bold text-blue-400">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Estrat√©gia de Intervalos de Rosas -->
      <div id="analise-intervalos" class="glass-effect rounded-xl p-3 mb-6 max-h-[200px] overflow-y-auto">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üìä Estrat√©gia de Intervalos de Rosas:</span>
          <div id="intervalos-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando an√°lise...</span>
          </div>
        </div>
      </div>

      <!-- Estrat√©gia de Intervalos de Minutos Rosas -->
      <div id="analise-minutos-rosas" class="glass-effect rounded-xl p-3 mb-6 max-h-[200px] overflow-y-auto">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-gray-300">üìä Estrat√©gia de Intervalos de Minutos Rosas:</span>
          <div id="minutos-rosas-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando an√°lise...</span>
          </div>
        </div>
        <div id="contador-minutos-rosas" class="mt-3 hidden">
          <div class="flex items-center justify-center gap-2 p-2 rounded-lg bg-gradient-to-r from-blue-500/20 to-cyan-500/20 border border-blue-500/30">
            <span class="text-xs font-semibold text-blue-300">‚è±Ô∏è Minutos desde √∫ltima rosa:</span>
            <span id="contador-valor" class="text-lg font-bold text-white">0</span>
            <span class="text-xs text-blue-300">min</span>
          </div>
          <div id="alerta-entrada" class="mt-2 text-center hidden">
            <div class="space-y-1">
              <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gradient-to-r from-yellow-500/40 to-orange-500/40 border-2 border-yellow-500/70 text-yellow-300 font-bold text-sm animate-pulse">
                ‚ö†Ô∏è PR√ìXIMO PADR√ÉO - PREPARAR ENTRADA ‚ö†Ô∏è
              </span>
              <div id="proxima-vela-info" class="text-xs text-yellow-200 bg-yellow-500/20 rounded px-2 py-1 border border-yellow-500/30">
                Pr√≥xima vela esperada em: <span id="minuto-esperado" class="font-bold">--</span> min
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Padr√µes Top -->
      <div id="padroes-top" class="glass-effect rounded-xl p-3 mb-6 border-2 border-green-500/50">
        <div class="flex items-center gap-3 flex-wrap text-xs sm:text-sm">
          <span class="font-semibold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-400">üéØ Padr√µes Top:</span>
          <div id="padroes-top-list" class="flex gap-2 flex-wrap">
            <span class="text-gray-500">Carregando...</span>
          </div>
        </div>
      </div>

      <!-- Painel de Padr√µes Mapeados -->
      <div id="padroes-panel" class="padroes-panel glass-effect rounded-2xl p-4 lg:block">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-white flex items-center gap-2">
            <span>üéØ</span>
            <span>Padr√µes Mapeados</span>
          </h3>
          <button id="minimize-padroes-btn" class="minimize-btn text-2xl text-gray-400 hover:text-white transition-colors" title="Minimizar/Expandir">
            ‚ñº
          </button>
        </div>
        <div id="padroes-list" class="space-y-3">
          <p class="text-gray-400 text-sm">Nenhum padr√£o detectado ainda...</p>
        </div>
      </div>

      <!-- Grid de Velas -->
      <div id="historico-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-2 sm:gap-2.5">
        <!-- As velas ser√£o inseridas aqui -->
      </div>

      <!-- Loading State -->
      <div id="loading" class="text-center py-12 hidden">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-indigo-500 border-t-transparent"></div>
        <p class="mt-4 text-gray-400">Carregando velas...</p>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const API_URL = "https://aviator.pixios.com.br/velas";

        const colorFilter = document.getElementById("color-filter");
        const intervalToggle = document.getElementById("interval-toggle");
        const historicoContainer = document.getElementById("historico-container");
        const loadingElement = document.getElementById("loading");
        const padroesPanel = document.getElementById("padroes-panel");
        const padroesList = document.getElementById("padroes-list");
        let selectedNumber = null;
        let selectedColorFilter = "all";
        let showIntervals = false;
        let padroesDetectados = [];
        let padroesDecimais = []; // Array para armazenar padr√µes decimais mapeados

        // Fun√ß√µes de LocalStorage
        function salvarPadroesNoStorage(padroes) {
          try {
            localStorage.setItem('padroesDetectados', JSON.stringify(padroes));
          } catch (error) {
            console.error('Erro ao salvar padr√µes no localStorage:', error);
          }
        }

        function carregarPadroesDoStorage() {
          try {
            const padroes = localStorage.getItem('padroesDetectados');
            return padroes ? JSON.parse(padroes) : [];
          } catch (error) {
            console.error('Erro ao carregar padr√µes do localStorage:', error);
            return [];
          }
        }

        function salvarPadroesDecimaisNoStorage(padroes) {
          try {
            localStorage.setItem('padroesDecimais', JSON.stringify(padroes));
          } catch (error) {
            console.error('Erro ao salvar padr√µes decimais no localStorage:', error);
          }
        }

        function carregarPadroesDecimaisDoStorage() {
          try {
            const padroes = localStorage.getItem('padroesDecimais');
            return padroes ? JSON.parse(padroes) : [];
          } catch (error) {
            console.error('Erro ao carregar padr√µes decimais do localStorage:', error);
            return [];
          }
        }

        // Carregar padr√µes salvos ao iniciar
        padroesDetectados = carregarPadroesDoStorage();
        padroesDecimais = carregarPadroesDecimaisDoStorage();

        // Fun√ß√£o para extrair decimal de um n√∫mero
        function extrairDecimal(numero) {
          const str = numero.toFixed(2);
          const partes = str.split('.');
          return partes.length > 1 ? '.' + partes[1] : '.00';
        }

        // NOVA FUN√á√ÉO: Detectar Padr√µes Top (apenas repeti√ß√£o nas 3 velas recentes)
        function detectarPadroesTop(velas) {
          if (velas.length < 3) return [];
          
          const padroesTop = [];
          
          // Pega as 3 velas mais recentes
          const vela1 = velas[0]; // Mais recente
          const vela2 = velas[1];
          const vela3 = velas[2];
          
          // Converte n√∫meros para string sem ponto: 10.50 -> "1050"
          const num1Str = vela1.numero.toFixed(2).replace('.', '');
          const num2Str = vela2.numero.toFixed(2).replace('.', '');
          const num3Str = vela3.numero.toFixed(2).replace('.', '');
          
          // Fun√ß√£o auxiliar para verificar se h√° 2 d√≠gitos iguais entre duas strings
          function temRepeticao(str1, str2) {
            const digitos1 = str1.split('');
            const digitos2 = str2.split('');
            
            // Procura 2 d√≠gitos consecutivos iguais
            for (let i = 0; i < digitos1.length - 1; i++) {
              const par1 = digitos1[i] + digitos1[i + 1];
              for (let j = 0; j < digitos2.length - 1; j++) {
                const par2 = digitos2[j] + digitos2[j + 1];
                if (par1 === par2) {
                  return { encontrado: true, digitos: par1, vela1: str1, vela2: str2 };
                }
              }
            }
            return { encontrado: false };
          }
          
          // Verifica todas as combina√ß√µes das 3 velas
          const combinacoes = [
            { v1: vela1, v2: vela2, s1: num1Str, s2: num2Str },
            { v1: vela1, v2: vela3, s1: num1Str, s2: num3Str },
            { v1: vela2, v2: vela3, s1: num2Str, s2: num3Str }
          ];
          
          for (const comb of combinacoes) {
            // Verifica apenas repeti√ß√£o
            const repeticao = temRepeticao(comb.s1, comb.s2);
            if (repeticao.encontrado) {
              padroesTop.push({
                tipo: 'Repeti√ß√£o',
                vela1: comb.v1.numero.toFixed(2) + 'x',
                vela2: comb.v2.numero.toFixed(2) + 'x',
                detalhes: `D√≠gitos ${repeticao.digitos} repetidos`,
                horario1: comb.v1.horario,
                horario2: comb.v2.horario
              });
            }
          }
          
          return padroesTop;
        }

        // Fun√ß√£o para renderizar Padr√µes Top
        function renderizarPadroesTop(padroesTop) {
          const padroesTopList = document.getElementById('padroes-top-list');
          
          if (padroesTop.length === 0) {
            padroesTopList.innerHTML = '<span class="text-gray-500">Nenhum padr√£o encontrado nas 3 √∫ltimas velas</span>';
            return;
          }
          
          // Remove duplicatas (mesma combina√ß√£o)
          const padroesUnicos = [];
          const vistos = new Set();
          
          for (const padrao of padroesTop) {
            const chave = `${padrao.tipo}-${padrao.vela1}-${padrao.vela2}`;
            if (!vistos.has(chave)) {
              vistos.add(chave);
              padroesUnicos.push(padrao);
            }
          }
          
          padroesTopList.innerHTML = padroesUnicos.map(padrao => {
            const bgClass = 'bg-gradient-to-r from-green-500/30 to-emerald-500/30 border-green-400/50';
            const emoji = 'üîÑ';
            
            return `
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg ${bgClass} border-2 shadow-lg">
                <span class="text-lg">${emoji}</span>
                <span class="font-bold text-white">${padrao.tipo}</span>
                <span class="text-gray-300">|</span>
                <span class="font-semibold text-yellow-300">${padrao.vela1}</span>
                <span class="text-gray-400">&</span>
                <span class="font-semibold text-yellow-300">${padrao.vela2}</span>
                <span class="text-gray-300">‚Üí</span>
                <span class="text-xs text-gray-300">${padrao.detalhes}</span>
              </span>
            `;
          }).join('');
        }

        // NOVA FUN√á√ÉO: Analisar mercado PAGUE/TOME
        function analisarMercadoPagueTome(velas) {
          if (velas.length < 6) {
            return { status: 'AGUARDANDO', mediaRoxas: 0, mediaAzuis: 0, velasAnalisadas: 0 };
          }
          
          // Pega as 6 velas mais recentes
          const ultimas6 = velas.slice(0, 6);
          
          // Conta quantas s√£o >= 2x
          let velasAcima2x = 0;
          const velasRoxas = []; // >= 2x e < 10x
          const velasAzuis = []; // < 2x
          
          ultimas6.forEach(vela => {
            const numero = parseFloat(vela.numero);
            if (numero >= 2) {
              velasAcima2x++;
              
              // Se for roxa (>= 2x e < 10x), adiciona ao array
              if (numero < 10) {
                velasRoxas.push(numero);
              }
            } else {
              // Se for azul (< 2x), adiciona ao array
              velasAzuis.push(numero);
            }
          });
          
          // Define se √© PAGUE ou TOME
          // PAGUE: >= 3 velas s√£o >= 2x (metade ou mais)
          // TOME: < 3 velas s√£o >= 2x
          const status = velasAcima2x >= 3 ? 'PAGUE' : 'TOME';
          
          // Calcula m√©dia das roxas
          let mediaRoxas = 0;
          if (velasRoxas.length > 0) {
            const soma = velasRoxas.reduce((acc, val) => acc + val, 0);
            mediaRoxas = soma / velasRoxas.length;
          }
          
          // Calcula m√©dia das azuis
          let mediaAzuis = 0;
          if (velasAzuis.length > 0) {
            const soma = velasAzuis.reduce((acc, val) => acc + val, 0);
            mediaAzuis = soma / velasAzuis.length;
          }
          
          return {
            status,
            mediaRoxas: mediaRoxas.toFixed(2),
            mediaAzuis: mediaAzuis.toFixed(2),
            velasAcima2x,
            totalVelasRoxas: velasRoxas.length,
            totalVelasAzuis: velasAzuis.length,
            velasAnalisadas: 6
          };
        }

        // Fun√ß√£o para renderizar status do mercado PAGUE/TOME
        function renderizarMercadoStatus(analise) {
          const mercadoBadge = document.getElementById('mercado-badge');
          const mediaRoxasElement = document.getElementById('media-roxas');
          const mediaAzuisElement = document.getElementById('media-azuis');
          
          if (analise.status === 'AGUARDANDO') {
            mercadoBadge.innerHTML = '<span class="text-gray-500">Aguardando dados...</span>';
            mediaRoxasElement.querySelector('span:last-child').textContent = '--';
            mediaAzuisElement.querySelector('span:last-child').textContent = '--';
            return;
          }
          
          const isPague = analise.status === 'PAGUE';
          const bgClass = isPague 
            ? 'bg-gradient-to-r from-green-500 to-emerald-600' 
            : 'bg-gradient-to-r from-red-500 to-orange-600';
          
          const emoji = isPague ? 'üí∞' : 'üéØ';
          
          mercadoBadge.className = `px-4 py-1.5 rounded-lg font-bold text-sm ${bgClass} text-white shadow-lg`;
          mercadoBadge.innerHTML = `${emoji} ${analise.status}`;
          
          // Atualiza m√©dia das roxas
          const mediaRoxasSpan = mediaRoxasElement.querySelector('span:last-child');
          if (analise.totalVelasRoxas > 0) {
            mediaRoxasSpan.textContent = `${analise.mediaRoxas}x`;
            mediaRoxasSpan.className = 'font-bold text-purple-300';
          } else {
            mediaRoxasSpan.textContent = 'Sem roxas';
            mediaRoxasSpan.className = 'font-bold text-gray-400 text-xs';
          }
          
          // Atualiza m√©dia das azuis
          const mediaAzuisSpan = mediaAzuisElement.querySelector('span:last-child');
          if (analise.totalVelasAzuis > 0) {
            mediaAzuisSpan.textContent = `${analise.mediaAzuis}x`;
            mediaAzuisSpan.className = 'font-bold text-blue-300';
          } else {
            mediaAzuisSpan.textContent = 'Sem azuis';
            mediaAzuisSpan.className = 'font-bold text-gray-400 text-xs';
          }
        }

        // Fun√ß√£o para detectar padr√µes decimais (vela ‚â•10x -> mapear decimal da 1¬™ antecessora)
        function detectarPadroesDecimais(velas) {
          const novosDecimais = [];
          
          // Percorre as velas DA MAIS ANTIGA PARA A MAIS RECENTE
          for (let i = velas.length - 1; i >= 0; i--) {
            const velaRosa = velas[i];
            const numeroRosa = parseFloat(velaRosa.numero);
            
            // Verifica se √© uma vela ‚â• 10x (rosa)
            if (numeroRosa >= 10) {
              // Pega a 1¬™ antecessora (vela imediatamente anterior)
              if (i + 1 < velas.length) {
                const antecessor1 = velas[i + 1];
                const numAnt1 = parseFloat(antecessor1.numero);
                const decimal = extrairDecimal(numAnt1);
                
                // Cria ID √∫nico para o padr√£o decimal
                const padraoId = `${velaRosa.horario}-${numeroRosa.toFixed(2)}-${decimal}`;
                
                // Verifica se j√° existe
                const jaExiste = padroesDecimais.some(p => p.id === padraoId);
                
                if (!jaExiste) {
                  const padrao = {
                    id: padraoId,
                    decimal: decimal,
                    velaRosa: {
                      numero: numeroRosa.toFixed(2),
                      horario: velaRosa.horario
                    },
                    antecessor1: {
                      numero: numAnt1.toFixed(2),
                      horario: antecessor1.horario
                    },
                    timestamp: Date.now(),
                    ocorrencias: 0, // Conta quantas vezes esse decimal apareceu depois
                    ultimaOcorrencia: null
                  };
                  
                  novosDecimais.push(padrao);
                }
              }
            }
          }
          
          // Adiciona novos padr√µes aos existentes (invertendo para manter ordem cronol√≥gica)
          if (novosDecimais.length > 0) {
            padroesDecimais = [...novosDecimais.reverse(), ...padroesDecimais];
            // Limita a 30 padr√µes decimais mais recentes
            padroesDecimais = padroesDecimais.slice(0, 30);
            salvarPadroesDecimaisNoStorage(padroesDecimais);
          }
          
          return padroesDecimais;
        }

        // Fun√ß√£o para atualizar ocorr√™ncias de padr√µes decimais
        function atualizarOcorrenciasDecimais(velas) {
          if (velas.length === 0 || padroesDecimais.length === 0) return;
          
          let atualizado = false;
          
          // Para cada padr√£o decimal mapeado
          padroesDecimais.forEach(padrao => {
            // Encontra o √≠ndice da vela rosa que originou o padr√£o
            let indiceVelaRosa = -1;
            for (let i = 0; i < velas.length; i++) {
              const vela = velas[i];
              const numero = parseFloat(vela.numero).toFixed(2);
              const horario = vela.horario;
              
              if (numero === padrao.velaRosa.numero && horario === padrao.velaRosa.horario) {
                indiceVelaRosa = i;
                break;
              }
            }
            
            // Se encontrou a vela rosa, conta ocorr√™ncias ap√≥s ela
            if (indiceVelaRosa !== -1) {
              let ocorrencias = 0;
              let ultimaOcorrencia = null;
              
              // Percorre velas AP√ìS a vela rosa (√≠ndices menores = mais recentes)
              for (let i = indiceVelaRosa - 1; i >= 0; i--) {
                const vela = velas[i];
                const numeroVela = parseFloat(vela.numero);
                const decimalVela = extrairDecimal(numeroVela);
                
                if (decimalVela === padrao.decimal) {
                  ocorrencias++;
                  if (!ultimaOcorrencia) {
                    ultimaOcorrencia = {
                      numero: numeroVela.toFixed(2),
                      horario: vela.horario
                    };
                  }
                }
              }
              
              if (padrao.ocorrencias !== ocorrencias) {
                padrao.ocorrencias = ocorrencias;
                padrao.ultimaOcorrencia = ultimaOcorrencia;
                atualizado = true;
              }
            }
          });
          
          if (atualizado) {
            salvarPadroesDecimaisNoStorage(padroesDecimais);
          }
        }

        // Fun√ß√£o para renderizar padr√µes decimais
        function renderizarPadroesDecimais(velas) {
          const decimaisList = document.getElementById('padroes-decimais-list');
          
          if (padroesDecimais.length === 0) {
            decimaisList.innerHTML = '<span class="text-gray-500">Nenhum padr√£o decimal mapeado ainda</span>';
            return;
          }
          
          // Obt√©m decimal da vela atual
          const velaAtual = velas.length > 0 ? velas[0] : null;
          const decimalAtual = velaAtual ? extrairDecimal(parseFloat(velaAtual.numero)) : null;
          
          decimaisList.innerHTML = padroesDecimais.map(padrao => {
            const isAtual = decimalAtual === padrao.decimal;
            
            const bgClass = isAtual 
              ? 'bg-gradient-to-r from-green-500/40 to-emerald-500/40 border-green-400/70 shadow-lg' 
              : 'bg-gradient-to-r from-green-500/20 to-emerald-500/20 border-green-500/30';
            
            const textClass = isAtual ? 'text-green-300' : 'text-green-400';
            
            const atualBadge = isAtual 
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-green-500 text-black rounded animate-pulse">‚ú® ATUAL</span>' 
              : '';
            
            return `
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg ${bgClass} border-2">
                ${atualBadge}
                <span class="font-bold ${textClass}">${padrao.decimal}</span>
                <span class="text-gray-400 text-xs">(${padrao.antecessor1.numero}x)</span>
                ${padrao.ocorrencias > 0 ? `<span class="text-xs text-yellow-400">üî•${padrao.ocorrencias}x</span>` : ''}
              </span>
            `;
          }).join('');
        }

        // Fun√ß√£o para detectar padr√µes (vela >= 5x com 2 antecessores < 2x)
        function detectarPadroes(velas) {
          const novosPadroes = [];
          
          // Percorre as velas DA MAIS ANTIGA PARA A MAIS RECENTE
          for (let i = velas.length - 1; i >= 0; i--) {
            const velaGatilho = velas[i];
            const numeroGatilho = parseFloat(velaGatilho.numero);
            
            // Verifica se √© uma vela >= 5x
            if (numeroGatilho >= 5) {
              // Verifica se temos pelo menos 2 velas anteriores
              if (i + 2 < velas.length) {
                const antecessor1 = velas[i + 1]; // 1¬™ antecessora (sem restri√ß√£o)
                const antecessor2 = velas[i + 2]; // 2¬™ antecessora (gatilho - deve ser < 2x)
                
                const numAnt1 = parseFloat(antecessor1.numero);
                const numAnt2 = parseFloat(antecessor2.numero);
                
                // Verifica APENAS se a 2¬™ antecessora √© < 2x (gatilho)
                // A 1¬™ antecessora pode ter qualquer valor
                if (numAnt2 < 2) {
                  // Cria ID √∫nico para o padr√£o baseado no gatilho (2¬™ antecessora)
                  const padraoId = `${velaGatilho.horario}-${numeroGatilho.toFixed(2)}`;
                  
                  // Verifica se j√° existe
                  const jaExiste = padroesDetectados.some(p => p.id === padraoId);
                  
                  if (!jaExiste) {
                    // Verifica se √© a primeira ou segunda ocorr√™ncia deste gatilho
                    const gatilhoNumero = numAnt2.toFixed(2);
                    const ocorrenciasAnteriores = padroesDetectados.filter(p => 
                      p.antecessor2.numero === gatilhoNumero
                    ).length;
                    
                    const padrao = {
                      id: padraoId,
                      velaGatilho: {
                        numero: numeroGatilho.toFixed(2),
                        horario: velaGatilho.horario
                      },
                      antecessor1: {
                        numero: numAnt1.toFixed(2),
                        horario: antecessor1.horario
                      },
                      antecessor2: {
                        numero: numAnt2.toFixed(2),
                        horario: antecessor2.horario
                      },
                      wins: 0,
                      losses: 0,
                      timestamp: Date.now(),
                      isPrimeiraOcorrencia: ocorrenciasAnteriores === 0
                    };
                    
                    novosPadroes.push(padrao);
                  }
                }
              }
            }
          }
          
          // Adiciona novos padr√µes aos existentes (invertendo para manter ordem cronol√≥gica)
          if (novosPadroes.length > 0) {
            padroesDetectados = [...novosPadroes.reverse(), ...padroesDetectados];
            // Limita a 50 padr√µes mais recentes
            padroesDetectados = padroesDetectados.slice(0, 50);
            salvarPadroesNoStorage(padroesDetectados);
          }
          
          return padroesDetectados;
        }

        // Fun√ß√£o para atualizar resultados dos padr√µes
        function atualizarResultadosPadroes(velas) {
          let atualizado = false;
          
          padroesDetectados.forEach(padrao => {
            // Se j√° tem resultado, pula
            if (padrao.resultado) return;
            
            // Se √© a primeira ocorr√™ncia, n√£o marca Win/Loss ainda
            if (padrao.isPrimeiraOcorrencia) {
              // Apenas marca como "mapeado" mas n√£o calcula resultado
              return;
            }
            
            // Procura o padr√£o nas velas
            for (let i = 0; i < velas.length; i++) {
              const vela = velas[i];
              const numero = parseFloat(vela.numero).toFixed(2);
              const horario = vela.horario;
              
              // Encontrou a vela gatilho do padr√£o
              if (numero === padrao.velaGatilho.numero && horario === padrao.velaGatilho.horario) {
                // Verifica se h√° uma vela ap√≥s o gatilho (resultado da entrada)
                if (i > 0) {
                  const velaResultado = velas[i - 1];
                  const numResultado = parseFloat(velaResultado.numero);
                  
                  // Se a pr√≥xima vela √© >= 5x, √© WIN
                  if (numResultado >= 5) {
                    padrao.wins = 1;
                    padrao.resultado = 'win';
                    atualizado = true;
                  } else {
                    // Se passou mais de 1 vela e n√£o deu win, √© LOSS
                    padrao.losses = 1;
                    padrao.resultado = 'loss';
                    atualizado = true;
                  }
                }
                break;
              }
            }
          });
          
          if (atualizado) {
            salvarPadroesNoStorage(padroesDetectados);
          }
        }

        // Fun√ß√£o para renderizar padr√µes no painel
        function renderizarPadroes(velas) {
          if (padroesDetectados.length === 0) {
            padroesList.innerHTML = '<p class="text-gray-400 text-sm">Nenhum padr√£o detectado ainda...</p>';
            return;
          }
          
          // Pega a vela atual (mais recente)
          const velaAtual = velas.length > 0 ? parseFloat(velas[0].numero).toFixed(2) : null;
          
          // Ordena padr√µes: vela atual primeiro, depois os demais por timestamp
          const padroesOrdenados = [...padroesDetectados].sort((a, b) => {
            const aIsAtual = velaAtual === a.antecessor2.numero;
            const bIsAtual = velaAtual === b.antecessor2.numero;
            
            if (aIsAtual && !bIsAtual) return -1;
            if (!aIsAtual && bIsAtual) return 1;
            return b.timestamp - a.timestamp;
          });
          
          padroesList.innerHTML = padroesOrdenados.map(padrao => {
            const isGatilhoAtual = velaAtual === padrao.antecessor2.numero;
            const cardClass = isGatilhoAtual ? 'gatilho-atual' : '';
            
            let statusBadge = '';
            if (padrao.resultado === 'win') {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-green-500 text-white rounded">‚úì WIN</span>';
            } else if (padrao.resultado === 'loss') {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-red-500 text-white rounded">‚úó LOSS</span>';
            } else if (padrao.isPrimeiraOcorrencia) {
              // Primeira ocorr√™ncia - apenas mapeado
              if (isGatilhoAtual) {
                statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-orange-500 text-black rounded animate-pulse">üî• VELA ATUAL</span>';
              } else {
                statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-blue-600 text-white rounded">üìç MAPEADO</span>';
              }
            } else if (isGatilhoAtual) {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-orange-500 text-black rounded animate-pulse">üî• VELA ATUAL</span>';
            } else {
              statusBadge = '<span class="px-2 py-1 text-xs font-bold bg-gray-600 text-white rounded">‚è≥ Aguardando</span>';
            }
            
            return `
              <div class="padrao-card glass-effect rounded-xl p-3 border border-indigo-500/30 ${cardClass}">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-semibold text-gray-400">Padr√£o Detectado</span>
                  ${statusBadge}
                </div>
                
                <div class="space-y-2">
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">Gatilho (2¬™ Ant.):</span>
                    <span class="font-bold text-blue-400">${padrao.antecessor2.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.antecessor2.horario}</span>
                  </div>
                  
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">1¬™ Antecessora:</span>
                    <span class="font-bold text-purple-400">${padrao.antecessor1.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.antecessor1.horario}</span>
                  </div>
                  
                  <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-400">Vela ‚â•5x:</span>
                    <span class="font-bold text-pink-400">${padrao.velaGatilho.numero}x</span>
                    <span class="text-xs text-gray-500">${padrao.velaGatilho.horario}</span>
                  </div>
                </div>
                
                <div class="mt-3 pt-3 border-t border-gray-700 flex items-center justify-between text-xs">
                  <div class="flex gap-3">
                    <span class="text-green-400 font-semibold">‚úì ${padrao.wins} Win${padrao.wins !== 1 ? 's' : ''}</span>
                    <span class="text-red-400 font-semibold">‚úó ${padrao.losses} Loss${padrao.losses !== 1 ? 'es' : ''}</span>
                  </div>
                  ${padrao.wins + padrao.losses > 0 ? `
                    <span class="text-gray-400">
                      ${((padrao.wins / (padrao.wins + padrao.losses)) * 100).toFixed(0)}% Acerto
                    </span>
                  ` : ''}
                </div>
              </div>
            `;
          }).join('');
        }

        // Fun√ß√£o para converter dados da API para o formato esperado
        function convertApiDataToVelas(apiData) {
          if (!apiData || !Array.isArray(apiData)) return [];
          
          return apiData.map((item, index) => {
            const numero = parseFloat(item.value || item.numero || 0);
            let cor = 'cinza';
            
            // Define a cor baseada no valor (usando a mesma l√≥gica da API)
            if (numero >= 10 || item.category === 'high' || item.category === 'mega') {
              cor = 'rosa';
            } else if (numero >= 2 || item.category === 'medium') {
              cor = 'roxa';
            } else {
              cor = 'azul';
            }
            
            // Gera um hor√°rio fict√≠cio baseado no timestamp atual menos o √≠ndice
            const now = new Date();
            now.setMinutes(now.getMinutes() - index);
            const horario = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            return {
              numero: numero,
              horario: horario,
              cor: cor,
              value: item.value,
              text: item.text,
              category: item.category
            };
          }).reverse(); // Inverte para mostrar as mais recentes primeiro
        }

        async function fetchVelas() {
          try {
            const response = await fetch(API_URL);
            const apiResponse = await response.json();

            if (apiResponse.success && apiResponse.candles && apiResponse.candles.length > 0) {
              const velas = convertApiDataToVelas(apiResponse.candles);
              renderVelas(velas.reverse());
            } else {
              console.log("‚ö†Ô∏è Nenhum dado dispon√≠vel da API");
              historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-gray-400">Aguardando dados da API...</p></div>';
            }
          } catch (error) {
            console.error("‚ùå Erro ao buscar velas da API:", error);
            historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-red-400">Erro ao conectar com a API. Verifique se o servidor est√° rodando.</p></div>';
          }
        }

        function getVelaClass(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "vela-rosa";
          }
          if (vela.cor === "roxa") {
            return "vela-roxa";
          }
          if (vela.cor === "azul") {
            return "vela-azul";
          }
          return "vela-cinza";
        }

        function getVelaType(vela) {
          const numero = parseFloat(vela.numero);
          if (numero >= 10) {
            return "rosa";
          }
          return vela.cor;
        }

        function shouldShowVela(velaType) {
          if (selectedColorFilter === "all") return true;
          return velaType === selectedColorFilter;
        }

        // NOVA FUN√á√ÉO: Analisar intervalos entre rosas
        function analisarIntervalosRosas(velas) {
          const intervalosMap = new Map();
          let ultimaRosaIndex = -1;
          
          // Percorre as velas da mais RECENTE para a mais ANTIGA
          for (let i = 0; i < velas.length; i++) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              // Se j√° temos uma rosa anterior, calcula o intervalo
              if (ultimaRosaIndex !== -1) {
                const intervalo = i - ultimaRosaIndex - 1; // -1 porque n√£o contamos a pr√≥pria rosa
                
                // S√≥ mapeia intervalos de at√© 10 casas
                if (intervalo > 0 && intervalo <= 10) {
                  intervalosMap.set(intervalo, (intervalosMap.get(intervalo) || 0) + 1);
                }
              }
              
              ultimaRosaIndex = i;
            }
          }
          
          // Converte o Map em array e ordena por intervalo (menor para maior)
          const intervalosArray = Array.from(intervalosMap.entries())
            .map(([intervalo, quantidade]) => ({
              intervalo,
              quantidade
            }))
            .sort((a, b) => a.intervalo - b.intervalo);
          
          // Calcula o intervalo atual (velas desde a √∫ltima rosa)
          let intervaloAtual = 0;
          if (velas.length > 0) {
            for (let i = 0; i < velas.length; i++) {
              const isRosa = parseFloat(velas[i].numero) >= 10;
              if (isRosa) {
                intervaloAtual = i;
                break;
              }
            }
          }
          
          return {
            intervalos: intervalosArray,
            intervaloAtual: intervaloAtual
          };
        }
        
        function renderIntervalosRosas(dados) {
          const intervalosList = document.getElementById('intervalos-list');

          if (dados.intervalos.length === 0) {
            intervalosList.innerHTML = '<span class="text-gray-500">Nenhum padr√£o de intervalo encontrado ainda</span>';
            return;
          }

          const { intervalos, intervaloAtual } = dados;

          intervalosList.innerHTML = intervalos.map(data => {
            // Verifica se o intervalo atual est√° pr√≥ximo deste padr√£o
            const isProximo = intervaloAtual > 0 && intervaloAtual === data.intervalo;

            // Define cores baseadas na quantidade de ocorr√™ncias
            let bgClass = 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30';
            let textClass = 'text-pink-400';

            if (data.quantidade >= 5) {
              bgClass = 'bg-gradient-to-r from-green-500/30 to-emerald-500/30 border-green-500/50';
              textClass = 'text-green-400';
            } else if (data.quantidade >= 3) {
              bgClass = 'bg-gradient-to-r from-yellow-500/30 to-orange-500/30 border-yellow-500/50';
              textClass = 'text-yellow-400';
            }

            // Badge de padr√£o atual
            const proximoBadge = isProximo
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-yellow-500 text-black rounded animate-pulse">üî• ATUAL</span>'
              : '';

            return `
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg ${bgClass} border shadow-md">
                ${proximoBadge}
                <span class="font-bold ${textClass}">${data.intervalo} Casa${data.intervalo > 1 ? 's' : ''}</span>
                <span class="text-gray-400 text-xs">‚Üí</span>
                <span class="font-semibold text-white text-sm">${data.quantidade}x</span>
              </span>
            `;
          }).join('');

          // Adiciona informa√ß√£o sobre o intervalo atual
          if (intervaloAtual > 0) {
            const infoAtual = document.createElement('div');
            infoAtual.className = 'w-full mt-2 px-2.5 py-1.5 rounded-lg bg-blue-500/20 border border-blue-500/30 text-xs text-blue-300';
            infoAtual.innerHTML = `üìç <strong>${intervaloAtual}</strong> vela${intervaloAtual > 1 ? 's' : ''} desde a √∫ltima rosa`;
            intervalosList.appendChild(infoAtual);
          }
        }

        // NOVA FUN√á√ÉO: Analisar pr√≥ximos minutos rosas (10 minutos ap√≥s cada rosa das √∫ltimas 20 velas)
        function analisarMinutosRosas(velas) {
          const proximosMinutos = [];

          // Limita a an√°lise √†s √∫ltimas 30 velas mais recentes
          const velasRecentes = velas.slice(0, 30);

          // Usa o hor√°rio da vela mais recente como refer√™ncia de "agora"
          const velaMaisRecente = velasRecentes[0];
          const horarioAtual = velaMaisRecente.horario; // formato "HH:MM"
          const [horaAtual, minAtual] = horarioAtual.split(':').map(Number);
          const totalMinAtual = horaAtual * 60 + minAtual;

          // Percorre as 20 velas recentes para encontrar rosas e calcular pr√≥ximos minutos
          for (let i = velasRecentes.length - 1; i >= 0; i--) {
            const vela = velasRecentes[i];
            const isRosa = parseFloat(vela.numero) >= 10;

            if (isRosa) {
              const horarioRosa = vela.horario; // formato "HH:MM"
              const [horaRosa, minRosa] = horarioRosa.split(':').map(Number);
              const totalMinRosa = horaRosa * 60 + minRosa;
              const totalMinProximo = totalMinRosa + 10; // 10 minutos ap√≥s a rosa

              const horaProxima = Math.floor(totalMinProximo / 60) % 24;
              const minProximo = totalMinProximo % 60;

              // Calcula diferen√ßa em rela√ß√£o ao hor√°rio atual (vela mais recente)
              const diffMin = totalMinProximo - totalMinAtual;

              // S√≥ adiciona se estiver no futuro (at√© 60 minutos √† frente)
              if (diffMin > 0 && diffMin <= 60) {
                proximosMinutos.push({
                  horarioRosa: horarioRosa,
                  horarioProximo: `${horaProxima.toString().padStart(2, '0')}:${minProximo.toString().padStart(2, '0')}`,
                  minutosFaltando: diffMin,
                  numeroRosa: vela.numero.toFixed(2)
                });
              }
            }
          }

          // Ordena por hor√°rio pr√≥ximo
          proximosMinutos.sort((a, b) => a.minutosFaltando - b.minutosFaltando);

          // Verifica se algum est√° muito pr√≥ximo (1 minuto ou menos)
          const alertaProximo = proximosMinutos.find(p => p.minutosFaltando <= 1);

          return {
            proximosMinutos: proximosMinutos.slice(0, 5), // Mostra apenas os 5 pr√≥ximos
            alertaProximo
          };
        }

        function renderizarMinutosRosas(dados) {
          const minutosList = document.getElementById('minutos-rosas-list');
          const contadorMinutos = document.getElementById('contador-minutos-rosas');
          const alertaEntrada = document.getElementById('alerta-entrada');

          // Remove old elements that are no longer used
          contadorMinutos.classList.add('hidden');
          alertaEntrada.classList.add('hidden');

          if (dados.proximosMinutos.length === 0) {
            minutosList.innerHTML = '<span class="text-gray-500">Nenhum hor√°rio previsto para pr√≥ximas rosas</span>';
            return;
          }

          const { proximosMinutos, alertaProximo } = dados;

          // Show alert if there's a very close upcoming time
          if (alertaProximo) {
            alertaEntrada.classList.remove('hidden');
            alertaEntrada.innerHTML = `
              <div class="space-y-1">
                <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-500/40 to-pink-500/40 border-2 border-red-500/70 text-red-300 font-bold text-sm animate-pulse">
                  ‚ö†Ô∏è ROSA PR√ìXIMA! ‚ö†Ô∏è
                </span>
                <div class="text-xs text-red-200 bg-red-500/20 rounded px-2 py-1 border border-red-500/30">
                  Pr√≥xima rosa esperada em: <span class="font-bold">${alertaProximo.horarioProximo}</span> (${alertaProximo.minutosFaltando} min)
                </div>
                <div class="text-xs text-gray-300">
                  Rosa anterior: ${alertaProximo.numeroRosa}x √†s ${alertaProximo.horarioRosa}
                </div>
              </div>
            `;
          }

          minutosList.innerHTML = proximosMinutos.map(data => {
            const isImediato = data.minutosFaltando <= 2;

            let bgClass = 'bg-gradient-to-r from-pink-500/20 to-purple-500/20 border-pink-500/30';
            let textClass = 'text-pink-400';

            if (isImediato) {
              bgClass = 'bg-gradient-to-r from-red-500/30 to-pink-500/30 border-red-500/50';
              textClass = 'text-red-400';
            }

            const imediatoBadge = isImediato
              ? '<span class="px-1.5 py-0.5 text-[10px] font-bold bg-red-500 text-white rounded animate-pulse">‚ö†Ô∏è PR√ìXIMO</span>'
              : '';

            return `
              <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg ${bgClass} border shadow-md">
                ${imediatoBadge}
                <span class="font-bold ${textClass}">${data.horarioProximo}</span>
                <span class="text-gray-400 text-xs">(${data.minutosFaltando} min)</span>
                <span class="text-gray-300 text-xs">‚Üê ${data.numeroRosa}x</span>
              </span>
            `;
          }).join('');
        }

        function renderVelas(velas) {
          loadingElement.classList.add('hidden');
          historicoContainer.innerHTML = "";
          
          // Armazena velas globalmente para uso em outras fun√ß√µes
          window.velasGlobais = velas;
          
          // NOVO: Analisa e renderiza mercado PAGUE/TOME
          const analiseMercado = analisarMercadoPagueTome(velas);
          renderizarMercadoStatus(analiseMercado);
          
          // NOVO: Analisa e renderiza intervalos de rosas
          const dadosIntervalos = analisarIntervalosRosas(velas);
          renderIntervalosRosas(dadosIntervalos);

          // NOVO: Analisa e renderiza intervalos de minutos rosas
          const dadosMinutos = analisarMinutosRosas(velas);
          renderizarMinutosRosas(dadosMinutos);

          // NOVO: Detecta e renderiza Padr√µes Top (repeti√ß√£o e sequ√™ncia)
          const padroesTop = detectarPadroesTop(velas);
          renderizarPadroesTop(padroesTop);
          
          // Detecta novos padr√µes
          detectarPadroes(velas);
          
          // Atualiza resultados dos padr√µes existentes
          atualizarResultadosPadroes(velas);
          
          // Renderiza padr√µes no painel
          renderizarPadroes(velas);
          
          // Primeiro, calcular os intervalos percorrendo do mais antigo para o mais recente
          const velasComIntervalo = [];
          let intervalCount = 0;
          let countingInterval = false;
          
          // Percorre do final para o in√≠cio (mais antigo para mais recente)
          for (let i = velas.length - 1; i >= 0; i--) {
            const vela = velas[i];
            const isRosa = parseFloat(vela.numero) >= 10;
            
            if (isRosa) {
              countingInterval = true;
              intervalCount = 0;
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            } else if (countingInterval) {
              intervalCount++;
              velasComIntervalo.unshift({ vela, intervalo: intervalCount });
            } else {
              velasComIntervalo.unshift({ vela, intervalo: 0 });
            }
          }
          
          // Pega vela atual para marcar gatilhos em laranja
          const velaAtual = velas.length > 0 ? parseFloat(velas[0].numero).toFixed(2) : null;
          const decimalAtual = velas.length > 0 ? extrairDecimal(parseFloat(velas[0].numero)) : null;
          
          // Verifica quais velas s√£o gatilhos atuais
          const gatilhosAtuais = new Set();
          padroesDetectados.forEach(padrao => {
            if (velaAtual === padrao.antecessor2.numero) {
              gatilhosAtuais.add(padrao.antecessor2.numero);
            }
          });
          
          // Verifica se a vela atual corresponde a algum padr√£o decimal mapeado
          const isDecimalMapeado = padroesDecimais.some(padrao => padrao.decimal === decimalAtual);
          
          // Agora renderiza as velas com os intervalos corretos
          velasComIntervalo.forEach(({ vela, intervalo }, index) => {
            const velaElement = document.createElement("div");
            const numero = parseFloat(vela.numero).toFixed(2);
            const horario = formatDate(vela.horario);
            const velaType = getVelaType(vela);
            const isRosa = parseFloat(vela.numero) >= 10;
            
            // Verifica se √© um gatilho atual
            const isGatilhoAtual = gatilhosAtuais.has(numero);
            
            // Verifica se √© a vela ATUAL (primeira/mais recente) com decimal mapeado
            const isVelaAtualComDecimal = index === 0 && isDecimalMapeado;
            
            // Verifica se a pr√≥xima vela √© rosa (√∫ltima antes da rosa)
            const isBeforeRosa = index > 0 && parseFloat(velasComIntervalo[index - 1].vela.numero) >= 10;
            const badgeClass = isBeforeRosa ? 'interval-badge before-rosa' : 'interval-badge';
            
            const intervalBadge = showIntervals && !isRosa && intervalo > 0
              ? `<div class="${badgeClass}">${intervalo}</div>`
              : '';
            
            velaElement.innerHTML = `
              ${intervalBadge}
              <div class="numero-vela">${numero}x</div>
              <div class="horario-vela">${horario}</div>
            `;
            
            velaElement.dataset.numero = numero;
            velaElement.dataset.type = velaType;
            velaElement.className = `vela-card p-2 sm:p-2.5 rounded-xl text-center cursor-pointer ${getVelaClass(vela)}`;
            
            // Prioridade: Decimal Mapeado > Gatilho Atual
            if (isVelaAtualComDecimal) {
              velaElement.classList.add('vela-decimal-mapeado');
            } else if (isGatilhoAtual) {
              velaElement.classList.add('vela-gatilho-atual');
            }

            // Aplica filtro de cor
            if (!shouldShowVela(velaType)) {
              velaElement.classList.add("dimmed");
            }

            if (selectedNumber && velaElement.dataset.numero === selectedNumber) {
              velaElement.classList.add("highlight");
            } else if (selectedNumber) {
              velaElement.classList.add("dimmed");
            }

            historicoContainer.appendChild(velaElement);
          });
          
          // Aplica o destaque nas velas rosas ap√≥s selecionadas
          if (selectedNumber) {
            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              if (velaDiv.dataset.numero === selectedNumber && index > 0) {
                const nextVela = allVelas[index - 1];
                const nextNumero = parseFloat(nextVela.dataset.numero);
                if (nextNumero >= 10) {
                  nextVela.classList.remove("dimmed");
                  nextVela.classList.add("next-rosa");
                }
              }
            });
          }
        }

        function handleVelaClick(event) {
          const target = event.target.closest('.vela-card');
          if (target && target.dataset.numero) {
            const clickedNumber = target.dataset.numero;

            if (selectedNumber === clickedNumber) {
              selectedNumber = null;
            } else {
              selectedNumber = clickedNumber;
            }

            const allVelas = Array.from(historicoContainer.children);
            allVelas.forEach((velaDiv, index) => {
              velaDiv.classList.remove("highlight", "dimmed", "next-rosa");
              
              if (selectedNumber) {
                // Se o n√∫mero atual √© o selecionado, destaca
                if (velaDiv.dataset.numero === selectedNumber) {
                  velaDiv.classList.add("highlight");
                  
                  // Verifica se a pr√≥xima vela √© rosa (>= 10)
                  if (index > 0) {
                    const nextVela = allVelas[index - 1];
                    const nextNumero = parseFloat(nextVela.dataset.numero);
                    if (nextNumero >= 10) {
                      nextVela.classList.remove("dimmed");
                      nextVela.classList.add("next-rosa");
                    }
                  }
                } else {
                  // Escurece as outras velas
                  velaDiv.classList.add("dimmed");
                }
              }
            });
          }
        }

        colorFilter.addEventListener("change", () => {
          selectedColorFilter = colorFilter.value;
          selectedNumber = null;
          fetchVelas();
        });

        intervalToggle.addEventListener("click", () => {
          showIntervals = !showIntervals;
          intervalToggle.setAttribute("aria-checked", showIntervals);
          
          if (showIntervals) {
            intervalToggle.classList.remove("bg-gray-600");
            intervalToggle.classList.add("bg-indigo-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-1");
            intervalToggle.querySelector("span").classList.add("translate-x-6");
          } else {
            intervalToggle.classList.remove("bg-indigo-600");
            intervalToggle.classList.add("bg-gray-600");
            intervalToggle.querySelector("span").classList.remove("translate-x-6");
            intervalToggle.querySelector("span").classList.add("translate-x-1");
          }
          
          fetchVelas();
        });

        historicoContainer.addEventListener("click", handleVelaClick);

        // Fun√ß√£o para formatar hor√°rio da API (formato: "HH:MM")
        function formatDate(timeString) {
          // A API retorna apenas "HH:MM", ent√£o vamos adicionar a data atual
          const now = new Date();
          const [hours, minutes] = timeString.split(':');
          const date = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(hours), parseInt(minutes));
          
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          const hrs = String(date.getHours()).padStart(2, '0');
          const mins = String(date.getMinutes()).padStart(2, '0');
          
          return `${day}/${month}/${year} - ${hrs}:${mins}`;
        }

        // Bot√£o de resetar API
        const resetApiBtn = document.getElementById("reset-api-btn");
        if (resetApiBtn) {
          resetApiBtn.addEventListener("click", async () => {
            const originalText = resetApiBtn.innerHTML;
            resetApiBtn.disabled = true;
            resetApiBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></span><span>Resetando...</span>';
            
            try {
              const response = await fetch(`https://aviator.pixios.com.br/start`);
              const data = await response.json();
              
              if (data.success) {
                console.log("‚úÖ Navegador reiniciado com sucesso");
                historicoContainer.innerHTML = '<div class="glass-effect rounded-xl p-6 text-center"><p class="text-green-400">‚úÖ Navegador reiniciado! Aguardando novos dados...</p></div>';
                
                // Aguarda 5 segundos e recarrega
                setTimeout(() => {
                  fetchVelas();
                }, 5000);
              } else {
                console.error("‚ùå Erro ao reiniciar:", data.error);
                alert("Erro ao reiniciar navegador: " + (data.error || "Erro desconhecido"));
              }
            } catch (error) {
              console.error("‚ùå Erro ao chamar endpoint de restart:", error);
              alert("Erro ao conectar com o servidor. Verifique se est√° rodando.");
            } finally {
              resetApiBtn.disabled = false;
              resetApiBtn.innerHTML = originalText;
            }
          });
        }

        // Funcionalidade de minimizar/expandir painel de padr√µes
        const minimizePadroesBtn = document.getElementById("minimize-padroes-btn");
        if (minimizePadroesBtn) {
          // Carrega estado salvo do localStorage
          const isPanelMinimized = localStorage.getItem('padroesPanelMinimized') === 'true';
          if (isPanelMinimized) {
            padroesPanel.classList.add('minimized');
            minimizePadroesBtn.classList.add('minimized');
            minimizePadroesBtn.textContent = '‚ñ≤';
          }

          minimizePadroesBtn.addEventListener("click", () => {
            const isMinimized = padroesPanel.classList.toggle('minimized');
            minimizePadroesBtn.classList.toggle('minimized');
            
            if (isMinimized) {
              minimizePadroesBtn.textContent = '‚ñ≤';
              localStorage.setItem('padroesPanelMinimized', 'true');
            } else {
              minimizePadroesBtn.textContent = '‚ñº';
              localStorage.setItem('padroesPanelMinimized', 'false');
            }
          });
        }

        // Fetch inicial
        loadingElement.classList.remove('hidden');
        fetchVelas();
        
        // Atualizar a cada 1 segundo
        setInterval(fetchVelas, 1000);
      });
    </script>
  </body>
</html>
